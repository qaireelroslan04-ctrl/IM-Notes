<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Obsidian-Style IM Tracker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Obsidian Dark Theme Palette */
            --bg-1: #1e1e1e;       /* App Background */
            --bg-2: #252526;       /* Sidebar Background */
            --bg-3: #333333;       /* Active Item / Hover */
            --text-normal: #dcddde;
            --text-muted: #858585;
            --accent: #7f6df2;     /* Your Purple Accent */
            --border: #333333;
            --danger: #cf6679;
            
            /* Dimensions */
            --sidebar-width: 300px;
            --header-height: 50px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-1);
            color: var(--text-normal);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LEFT PANE: FILE EXPLORER --- */
        #app-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }

        /* Sidebar Header (Vault Name & Actions) */
        .sidebar-header {
            height: var(--header-height);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-normal);
        }

        .icon-btn {
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; padding: 4px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background-color: var(--bg-3); color: var(--text-normal); }

        /* Search Bar */
        .search-container {
            padding: 10px 16px;
        }
        .search-input {
            width: 100%;
            background-color: #111;
            border: 1px solid #333;
            padding: 6px 10px;
            border-radius: 4px;
            color: var(--text-normal);
            font-size: 0.85rem;
        }
        .search-input:focus { border-color: var(--accent); }

        /* File Tree */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px 20px 8px;
        }

        /* Tree Item Base */
        .tree-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: background 0.1s;
        }
        .tree-item:hover { background-color: var(--bg-3); color: var(--text-normal); }
        .tree-item.active { background-color: #37373d; color: #fff; }

        /* Folder Specifics */
        .folder-header { font-weight: 600; color: var(--text-normal); }
        .collapse-icon {
            width: 16px; height: 16px; margin-right: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; transition: transform 0.2s;
        }
        .collapse-icon.open { transform: rotate(90deg); }
        
        /* File Specifics */
        .file-item { padding-left: 28px; } /* Indentation */
        .file-icon { margin-right: 8px; font-size: 0.9rem; }
        
        /* Indentation Logic for Nested Folders */
        .folder-content { display: none; border-left: 1px solid #333; margin-left: 11px; padding-left: 4px; }
        .folder-content.show { display: block; }

        /* Indicators */
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 8px; }
        .dot.red { background-color: #ff5555; box-shadow: 0 0 5px rgba(255,85,85,0.4); }
        .dot.yellow { background-color: #f1c40f; }

        /* --- RIGHT PANE: EDITOR --- */
        #app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-1);
            position: relative;
        }

        /* Mobile Header (Hamburger) */
        .mobile-nav {
            display: none; height: 50px; border-bottom: 1px solid var(--border);
            align-items: center; padding: 0 16px; background: var(--bg-2);
        }

        /* Breadcrumbs / Note Header */
        .editor-header {
            padding: 20px 40px 0 40px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .breadcrumbs { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; font-family: 'JetBrains Mono', monospace; }
        
        input.note-title-edit {
            background: transparent; border: none; color: var(--text-normal);
            font-size: 2rem; font-weight: 700; width: 100%;
            font-family: 'Inter', sans-serif;
        }

        /* Editor Surface */
        .editor-canvas {
            flex: 1;
            overflow-y: auto;
            padding: 20px 40px 100px 40px;
            cursor: text;
        }
        .editor-content {
            max-width: 820px;
            margin: 0 auto;
            font-size: 1.1rem;
            line-height: 1.7;
            min-height: 60vh;
        }
        .editor-content:empty:before { content: 'Start writing...'; color: #444; }
        
        /* Markdown-ish Styling */
        .editor-content h1, h2, h3 { color: #fff; margin-top: 1.5em; }
        .editor-content h2 { border-bottom: 1px solid var(--border); padding-bottom: 0.5em; color: var(--accent); }
        .editor-content blockquote { border-left: 3px solid var(--accent); margin: 0; padding-left: 1em; color: var(--text-muted); }
        .editor-content code { background: #2d2d2d; padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }

        /* Floating Edit Toggle */
        .mode-switch {
            position: absolute; top: 15px; right: 20px;
            background: #252526; border: 1px solid #444; color: #ccc;
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem;
            cursor: pointer; font-weight: 600; text-transform: uppercase;
            z-index: 50; transition: all 0.2s;
        }
        .mode-switch.active { border-color: var(--accent); color: var(--accent); background: rgba(127,109,242,0.1); }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-nav { display: flex; }
            #app-sidebar { position: fixed; height: 100%; z-index: 100; transform: translateX(-100%); }
            #app-sidebar.open { transform: translateX(0); }
            .editor-header, .editor-canvas { padding-left: 20px; padding-right: 20px; }
            .mode-switch { top: 60px; }
        }
    </style>
</head>
<body>

    <aside id="app-sidebar">
        <div class="sidebar-header">
            <span>IM VAULT</span>
            <div style="display:flex; gap:5px;">
                <button class="icon-btn" title="New Note" onclick="createNewNote()">+</button>
                <button class="icon-btn" title="Close" onclick="toggleSidebar()" style="display:none;" id="close-sidebar-btn">x</button>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search files..." id="search-box">
        </div>

        <div id="file-tree" class="file-tree">
            </div>
    </aside>

    <section id="app-main">
        <div class="mobile-nav">
            <button class="icon-btn" onclick="toggleSidebar()" style="font-size:1.2rem;">☰</button>
            <span style="margin-left:15px; font-weight:600;">IM Curriculum</span>
        </div>

        <button id="edit-mode-btn" class="mode-switch" onclick="toggleEditMode()">Read Only</button>

        <div class="editor-header">
            <div class="breadcrumbs" id="breadcrumbs">Vault / Select a file</div>
            <input type="text" class="note-title-edit" id="note-title" value="" placeholder="Untitled" readonly>
        </div>

        <div class="editor-canvas" onclick="focusEditor()">
            <div id="editor" class="editor-content" spellcheck="false" contenteditable="false"></div>
        </div>
    </section>

    <script>
        // --- DATA (Populated from your PDF) ---
        // Notice the deep nesting for History Taking as requested
        const vaultData = [
            {
                id: 'folder-cvs', title: '1. Cardiovascular', type: 'folder', isOpen: true, children: [
                    {
                        id: 'folder-cvs-hx', title: 'History & Exam', type: 'folder', isOpen: true, children: [
                            { 
                                id: 'folder-hx-taking', title: 'History Taking', type: 'folder', isOpen: true, children: [
                                    { id: 'note-cvs-grading', title: 'Grading Effort Intolerance', type: 'note', tag: 'must', content: '<h2>NYHA Classification</h2><ul><li><b>Class I:</b> No limitation of physical activity.</li><li><b>Class II:</b> Slight limitation. Comfortable at rest.</li><li><b>Class III:</b> Marked limitation. Less than ordinary activity causes symptoms.</li><li><b>Class IV:</b> Unable to carry on any physical activity without discomfort. Symptoms at rest.</li></ul>' },
                                    { id: 'note-cvs-sob', title: 'SOB & Orthopnoea', type: 'note', tag: 'must', content: '<h2>Shortness of Breath</h2><p>Differentiate cardiac vs respiratory causes...</p><h3>Orthopnoea</h3><p>Breathlessness on lying flat...</p>' },
                                    { id: 'note-cvs-risk', title: 'Risk Factors', type: 'note', tag: 'must', content: '<h2>Major Risk Factors</h2><ul><li>Hypertension</li><li>Diabetes Mellitus</li><li>Dyslipidaemia</li><li>Smoking</li><li>Family History</li></ul>' }
                                ]
                            },
                            { 
                                id: 'folder-exam', title: 'Physical Exam', type: 'folder', children: [
                                    { id: 'note-exam-hands', title: 'Hands', type: 'note', tag: 'must', content: 'Clubbing, Splinter Haemorrhages, Janeway Lesions...' },
                                    { id: 'note-exam-precord', title: 'Precordium', type: 'note', tag: 'must', content: 'Apex beat character, Heaves, Thrills...' }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'folder-htn', title: 'Hypertension', type: 'folder', children: [
                             { id: 'note-htn-def', title: 'Definitions', type: 'note', tag: 'must', content: 'BP > 140/90 mmHg...' },
                             { id: 'note-htn-sec', title: 'Secondary Causes', type: 'note', tag: 'good', content: 'ROPE: Renal disease, Obesity, Pregnancy, Endocrine...' }
                        ]
                    }
                ]
            },
            {
                id: 'folder-resp', title: '2. Respiratory', type: 'folder', children: [
                    { id: 'folder-asthma', title: 'Bronchial Asthma', type: 'folder', children: [
                        { id: 'note-asthma-dx', title: 'Diagnosis', type: 'note', tag: 'must', content: 'Spirometry showing reversibility > 12%...' },
                        { id: 'note-asthma-acute', title: 'Acute Management', type: 'note', tag: 'must', content: 'Oxygen, Salbutamol, Hydrocortisone...' }
                    ]}
                ]
            },
             {
                id: 'folder-rheum', title: '9. Rheumatology', type: 'folder', children: [
                    { id: 'folder-gout', title: 'Gout', type: 'folder', children: [
                        { id: 'note-gout-acute', title: 'Acute Gout', type: 'note', tag: 'must', content: 'Monoarthritis, usually 1st MTPJ...' },
                        { id: 'note-gout-chronic', title: 'Chronic Tophaceous', type: 'note', tag: 'must', content: 'Tophi formation, bone destruction...' }
                    ]}
                ]
            }
        ];

        // --- APP STATE ---
        let activeNoteId = null;
        let isEditMode = false;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTree(vaultData, document.getElementById('file-tree'));
            
            // Search listener
            document.getElementById('search-box').addEventListener('input', (e) => filterTree(e.target.value));
        });

        // --- RENDERER (Recursive) ---
        function renderTree(nodes, container, depth = 0) {
            container.innerHTML = ''; // Clear current level
            
            nodes.forEach(node => {
                if (node.hidden) return; // For search filtering

                if (node.type === 'folder') {
                    // 1. Folder Header
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'tree-item folder-header';
                    // Indent based on depth? No, we use margin in CSS for children
                    folderDiv.onclick = (e) => toggleFolder(e, node, childrenContainer);

                    folderDiv.innerHTML = `
                        <span class="collapse-icon ${node.isOpen ? 'open' : ''}">▶</span>
                        <span>${node.title}</span>
                    `;
                    container.appendChild(folderDiv);

                    // 2. Folder Children Container
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = `folder-content ${node.isOpen ? 'show' : ''}`;
                    container.appendChild(childrenContainer);

                    // Recurse
                    renderTree(node.children, childrenContainer, depth + 1);

                } else {
                    // 3. File Item
                    const fileDiv = document.createElement('div');
                    fileDiv.className = `tree-item file-item ${activeNoteId === node.id ? 'active' : ''}`;
                    fileDiv.onclick = () => openNote(node);

                    // Tag Color
                    let dotClass = node.tag === 'must' ? 'red' : (node.tag === 'good' ? 'yellow' : 'gray');
                    
                    fileDiv.innerHTML = `
                        <div class="dot ${dotClass}"></div>
                        <span>${node.title}</span>
                    `;
                    container.appendChild(fileDiv);
                }
            });
        }

        // --- ACTIONS ---
        function toggleFolder(e, node, container) {
            e.stopPropagation();
            node.isOpen = !node.isOpen;
            // Update UI directly for speed
            const icon = e.currentTarget.querySelector('.collapse-icon');
            if(node.isOpen) {
                container.classList.add('show');
                icon.classList.add('open');
            } else {
                container.classList.remove('show');
                icon.classList.remove('open');
            }
        }

        function openNote(node) {
            activeNoteId = node.id;
            
            // Highlight in sidebar
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            // Re-render whole tree is safest but slow, let's just find the element if possible or re-render
            renderTree(vaultData, document.getElementById('file-tree'));

            // Mobile: Close sidebar
            if (window.innerWidth <= 768) toggleSidebar();

            // Populate Editor
            const breadcrumbPath = getBreadcrumbs(vaultData, node.id);
            document.getElementById('breadcrumbs').innerText = breadcrumbPath;
            document.getElementById('note-title').value = node.title;
            document.getElementById('editor').innerHTML = node.content || '';
        }

        function getBreadcrumbs(nodes, targetId, path = '') {
            for (let node of nodes) {
                if (node.id === targetId) return path ? `${path} / ${node.title}` : node.title;
                if (node.children) {
                    const found = getBreadcrumbs(node.children, targetId, path ? `${path} / ${node.title}` : node.title);
                    if (found) return found;
                }
            }
            return null;
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            const editor = document.getElementById('editor');
            const title = document.getElementById('note-title');

            if (isEditMode) {
                btn.innerText = 'Edit Mode: ON';
                btn.classList.add('active');
                editor.contentEditable = true;
                title.removeAttribute('readonly');
                editor.focus();
            } else {
                btn.innerText = 'Read Only';
                btn.classList.remove('active');
                editor.contentEditable = false;
                title.setAttribute('readonly', true);
                // Here you would save to Firebase
                console.log("Saving content...", editor.innerHTML);
            }
        }

        function focusEditor() {
            if (isEditMode) document.getElementById('editor').focus();
        }

        // --- SEARCH ---
        function filterTree(query) {
            const lowerQ = query.toLowerCase();
            
            function filterNodes(nodes) {
                let hasVisibleChild = false;
                nodes.forEach(node => {
                    if (node.type === 'folder') {
                        const childVisible = filterNodes(node.children);
                        node.hidden = !childVisible && !node.title.toLowerCase().includes(lowerQ);
                        if (!node.hidden) {
                            node.isOpen = true; // Auto expand on search
                            hasVisibleChild = true;
                        }
                    } else {
                        // Search Title AND Content
                        const match = node.title.toLowerCase().includes(lowerQ) || (node.content && node.content.toLowerCase().includes(lowerQ));
                        node.hidden = !match;
                        if (match) hasVisibleChild = true;
                    }
                });
                return hasVisibleChild;
            }

            filterNodes(vaultData);
            renderTree(vaultData, document.getElementById('file-tree'));
        }

        // --- UI UTILS ---
        function toggleSidebar() {
            const sb = document.getElementById('app-sidebar');
            const closeBtn = document.getElementById('close-sidebar-btn');
            sb.classList.toggle('open');
            
            // Toggle close button visibility on mobile
            if (window.innerWidth <= 768) {
                closeBtn.style.display = sb.classList.contains('open') ? 'block' : 'none';
            }
        }
        
        function createNewNote() {
            alert("This would create a new note in the current folder. (Functionality placeholder)");
        }

    </script>
</body>
</html>
