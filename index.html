<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IM Obsidian V9 (Enhanced)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <style>
        :root {
            /* Obsidian-like Theme */
            --bg-1: #1e1e1e;       
            --bg-2: #252526;       
            --bg-3: #2d2d2d;       
            --bg-search: #333;
            --text-main: #e0e0e0;
            --text-muted: #858585;
            --accent: #7f6df2;     
            --accent-hover: #6a5acd;
            --border: #333333;
            --danger: #e06c75;
            
            --sidebar-width: 320px;
            --header-height: 50px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-1);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #app-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.2s ease;
            z-index: 50;
        }

        .sidebar-header {
            height: var(--header-height);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-main);
            background: var(--bg-2);
        }

        .sidebar-actions button {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 4px; border-radius: 4px;
            font-size: 1rem; transition: 0.2s;
        }
        .sidebar-actions button:hover { color: #fff; background: var(--bg-3); }

        .search-container { padding: 10px 16px; background: var(--bg-2); }
        .search-input {
            width: 100%; background-color: #181818; border: 1px solid #333;
            padding: 8px 12px; border-radius: 6px; color: var(--text-main); font-size: 0.85rem;
        }
        .search-input:focus { border-color: var(--accent); }

        .file-tree { flex: 1; overflow-y: auto; padding: 5px 0 20px 0; }

        .tree-item {
            display: flex; align-items: center; padding: 5px 8px 5px 20px;
            cursor: pointer; font-size: 0.85rem; color: var(--text-muted);
            border-left: 2px solid transparent; position: relative;
        }
        .tree-item:hover { background-color: var(--bg-3); color: var(--text-main); }
        .tree-item.active { background-color: rgba(127,109,242,0.1); color: #fff; border-left-color: var(--accent); }

        .folder-content { display: none; margin-left: 12px; border-left: 1px solid #333; }
        .folder-content.show { display: block; }
        
        .arrow { 
            width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center;
            margin-right: 6px; font-size: 0.7rem; transition: transform 0.2s; 
        }
        .arrow.open { transform: rotate(90deg); }

        .node-controls { display: none; margin-left: auto; gap: 4px; }
        .tree-item:hover .node-controls { display: flex; }
        .ctrl-btn {
            width: 20px; height: 20px; border-radius: 3px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
            background: #444; color: #ccc;
        }
        .ctrl-btn:hover { background: var(--accent); color: white; }
        .ctrl-btn.del:hover { background: var(--danger); }

        /* Search Results */
        .search-results { display: none; flex-direction: column; padding: 0; }
        .search-result-item { padding: 10px 16px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .search-result-item:hover { background: var(--bg-3); }
        .result-path { font-size: 0.7rem; color: var(--accent); margin-bottom: 4px; }
        .result-title { font-weight: 600; font-size: 0.9rem; color: #fff; margin-bottom: 4px; }
        .result-snippet { font-size: 0.8rem; color: #aaa; font-style: italic; }

        /* --- MAIN AREA --- */
        #app-main {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--bg-1); position: relative;
        }

        .main-header {
            height: var(--header-height); display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid var(--border); background: var(--bg-1);
        }
        
        /* Dropdown */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 100%;
            background-color: var(--bg-2); min-width: 220px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 200;
            border: 1px solid var(--border); border-radius: 6px;
        }
        .dropdown-content button {
            color: var(--text-main); padding: 12px 16px; text-decoration: none;
            display: block; width: 100%; text-align: left; background: none; border: none; cursor: pointer;
            font-size: 0.85rem;
        }
        .dropdown-content button:hover { background-color: var(--bg-3); }
        .dropdown.show .dropdown-content { display: block; }

        .mode-toggle {
            background: var(--bg-2); border: 1px solid var(--border); color: var(--text-muted);
            padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-right: 10px;
        }
        .mode-toggle.active { color: var(--accent); border-color: var(--accent); background: rgba(127,109,242,0.1); }

        /* Editor Toolbar */
        .editor-toolbar {
            display: none; align-items: center; gap: 8px; padding: 10px 20px;
            background: var(--bg-1); border-bottom: 1px solid var(--border);
            overflow-x: auto; white-space: nowrap;
        }
        .editor-toolbar.visible { display: flex; }
        
        .fmt-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted);
            cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.9rem;
            min-width: 30px; text-align: center;
        }
        .fmt-btn:hover { background: var(--bg-3); color: #fff; }
        .fmt-btn.active { color: var(--accent); }

        .editor-scroll { flex: 1; overflow-y: auto; padding: 0 20px 50px 20px; }
        .editor-container { max-width: 800px; margin: 0 auto; padding-top: 40px; }

        .breadcrumbs { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; font-family: 'JetBrains Mono', monospace; }
        .note-title-input {
            width: 100%; background: transparent; border: none; color: var(--text-main);
            font-size: 2.2rem; font-weight: 800; font-family: 'Inter', sans-serif; margin-bottom: 20px;
        }

        .note-content { font-size: 1.1rem; line-height: 1.7; color: #d4d4d4; min-height: 60vh; tab-size: 4; }
        .note-content:empty:before { content: 'Start writing...'; color: #444; }

        .note-content h1, .note-content h2, .note-content h3 { color: #fff; margin-top: 1.5em; }
        .note-content h2 { border-bottom: 1px solid var(--border); padding-bottom: 0.3em; color: var(--accent); }
        .note-content blockquote { border-left: 3px solid var(--accent); margin: 1em 0; padding-left: 1em; color: var(--text-muted); background: rgba(127,109,242,0.05); padding: 10px; border-radius: 0 4px 4px 0; }
        .note-content img { max-width: 100%; border-radius: 4px; border: 1px solid var(--border); }
        .note-content a { color: var(--accent); text-decoration: underline; }
        .note-content hr { border: 0; border-top: 1px solid var(--border); margin: 20px 0; }

        .mobile-hamburger { display: none; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        
        @media (max-width: 768px) {
            #app-sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            #app-sidebar.open { transform: translateX(0); }
            .mobile-hamburger { display: block; }
            .main-header { padding: 0 10px; }
        }
    </style>
</head>
<body>

<aside id="app-sidebar">
    <div class="sidebar-header">
        <span id="connection-status" style="color:#22c55e">‚óè Firebase Connected</span>
        <div class="sidebar-actions">
            <button onclick="toggleAllFolders(false)" title="Collapse All">-</button>
        </div>
    </div>
    
    <div class="search-container">
        <input type="text" class="search-input" placeholder="Search notes..." id="search-input">
    </div>

    <div id="file-tree" class="file-tree">
        <div style="padding:20px; text-align:center; color:#666">Loading database...</div>
    </div>

    <div id="search-results-list" class="search-results file-tree"></div>
</aside>

<section id="app-main">
    
    <header class="main-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="mobile-hamburger" onclick="toggleSidebar()">‚ò∞</button>
            <span style="font-weight:600; font-size:0.9rem;">Workspace</span>
        </div>

        <div style="display:flex; align-items:center;">
            <button id="mode-toggle" class="mode-toggle" onclick="toggleEditMode()">Read Only</button>
            
            <div class="dropdown">
                <button class="icon-btn" onclick="toggleDropdown()" style="background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">‚ãÆ</button>
                <div id="settings-dropdown" class="dropdown-content">
                    <button onclick="initializeWithPDFData()" style="color: #7f6df2; font-weight:bold;">Initialize/Reset DB with PDF Data</button>
                    <button onclick="exportData()">Export Data (JSON)</button>
                    <button onclick="importData()">Import JSON</button>
                </div>
            </div>
        </div>
    </header>

    <div id="editor-toolbar" class="editor-toolbar">
        <button class="fmt-btn" onclick="fmt('undo')" title="Undo">‚Ü∫</button>
        <button class="fmt-btn" onclick="fmt('redo')" title="Redo">‚Üª</button>
        <div style="width:1px; background:#444; height:20px;"></div>
        <button class="fmt-btn" onclick="fmt('bold')" title="Bold">B</button>
        <button class="fmt-btn" onclick="fmt('italic')" title="Italic">I</button>
        <button class="fmt-btn" onclick="fmt('underline')" title="Underline">U</button>
        <button class="fmt-btn" onclick="fmt('strikeThrough')" title="Strikethrough"><s>S</s></button>
        <div style="width:1px; background:#444; height:20px;"></div>
        <button class="fmt-btn" onclick="fmt('formatBlock', 'H2')" title="Heading 2">H2</button>
        <button class="fmt-btn" onclick="fmt('formatBlock', 'H3')" title="Heading 3">H3</button>
        <button class="fmt-btn" onclick="fmt('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
        <button class="fmt-btn" onclick="fmt('insertOrderedList')" title="Numbered List">1. List</button>
        <button class="fmt-btn" onclick="fmt('insertHorizontalRule')" title="Line Divider">‚Äî</button>
        <div style="width:1px; background:#444; height:20px;"></div>
        <button class="fmt-btn" onclick="insertLink()" title="Link">Link</button>
        <button class="fmt-btn" onclick="insertImage()" title="Image">Image</button>
        <button class="fmt-btn" onclick="insertVideo()" title="YouTube">Video</button>
    </div>

    <div class="editor-scroll" onclick="focusEditor()">
        <div class="editor-container">
            <div id="breadcrumbs" class="breadcrumbs">Start</div>
            <input type="text" id="note-title" class="note-title-input" placeholder="No Note Selected" readonly>
            <div id="editor" class="note-content" contenteditable="false"></div>
        </div>
    </div>

</section>

<script>
    // --- 1. FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
        authDomain: "im-helper-d3a4a.firebaseapp.com",
        projectId: "im-helper-d3a4a",
        storageBucket: "im-helper-d3a4a.firebasestorage.app",
        messagingSenderId: "772636018512",
        appId: "1:772636018512:web:80d03d582a3384746f4e55",
        measurementId: "G-JTPQPT45CY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // --- 2. STATE ---
    let vaultData = [];
    let currentNoteId = null;
    let isEditMode = false;
    let saveTimeout;

    // --- 3. INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        loadStructureFromDB();

        // Search listener
        document.getElementById('search-input').addEventListener('input', handleSearch);
        
        // Autosave listener
        document.getElementById('editor').addEventListener('input', () => {
             if(currentNoteId) {
                 clearTimeout(saveTimeout);
                 saveTimeout = setTimeout(() => saveNoteContent(currentNoteId), 1000);
             }
        });

        // Click outside closes dropdown
        window.onclick = function(event) {
            if (!event.target.matches('.icon-btn')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].style.display === "block") dropdowns[i].style.display = "none";
                }
            }
        }

        // --- TAB KEY HANDLER ---
        document.getElementById('editor').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                // Check if in a list
                if (document.queryCommandState('insertUnorderedList') || document.queryCommandState('insertOrderedList')) {
                    // List: Indent / Outdent
                    document.execCommand(e.shiftKey ? 'outdent' : 'indent');
                } else {
                    // Regular Text: Insert Tab Character (Visual Tab)
                    if (!document.execCommand('insertText', false, '\t')) {
                        // Fallback for browsers that don't support insertText well
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const tabNode = document.createTextNode("\u00a0\u00a0\u00a0\u00a0");
                        range.insertNode(tabNode);
                        range.setStartAfter(tabNode);
                        range.setEndAfter(tabNode); 
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            }
        });
    });

    // --- 4. DB FUNCTIONS ---
    async function loadStructureFromDB() {
        try {
            const doc = await db.collection('config').doc('treeStructure').get();
            if (doc.exists) {
                vaultData = doc.data().tree;
                renderTree(vaultData, document.getElementById('file-tree'));
            } else {
                vaultData = [];
                renderTree([], document.getElementById('file-tree'));
                document.getElementById('file-tree').innerHTML = '<div style="padding:20px; text-align:center; color:#888">Database Empty.<br><br>Click ‚ãÆ > Initialize with PDF Data</div>';
            }
        } catch (error) {
            console.error("Error loading tree:", error);
            document.getElementById('connection-status').style.color = 'red';
            document.getElementById('connection-status').innerText = '‚óè Connection Failed';
        }
    }

    async function saveStructureToDB() {
        try { await db.collection('config').doc('treeStructure').set({ tree: vaultData }); } 
        catch(e) { console.error("Save failed", e); }
    }

    async function saveNoteContent(id) {
        const content = document.getElementById('editor').innerHTML;
        const title = document.getElementById('note-title').value;
        
        const node = findNode(vaultData, id);
        if(node) node.content = content; 

        try {
            await db.collection('notes').doc(id).set({
                content: content,
                title: title,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("Note saved.");
            saveStructureToDB();
        } catch(e) { console.error("Note save failed", e); }
    }

    async function initializeWithPDFData() {
        if(!confirm("This will OVERWRITE your existing sidebar structure. Continue?")) return;
        
        // Initial Data Structure
        const initialData = [
            { id: '1', title: '1. Cardiovascular', type: 'folder', isOpen: true, children: [
                { id: '1-1', title: 'History & Exam', type: 'folder', isOpen: false, children: [
                    { id: '1-1-1', title: 'History Taking', type: 'folder', children: [
                        { id: '1-1-1-a', title: 'Symptoms', type: 'file', content: '<h2>Grading Effort Intolerance</h2><p>NYHA Classification...</p><h2>Chest Pain</h2><p>SOCRATES method...</p>' },
                        { id: '1-1-1-b', title: 'Risk Factors', type: 'file', content: '<ul><li>Hypertension</li><li>Diabetes</li><li>Smoking</li></ul>' }
                    ]},
                    { id: '1-1-2', title: 'Physical Exam', type: 'file', content: 'Hands, Pulse, JVP, Apex Beat...' }
                ]},
                { id: '1-2', title: 'Hypertension', type: 'file', content: 'Definitions, Secondary Causes (Renal, Endocrine)...' }
            ]},
            { id: '2', title: '2. Respiratory', type: 'folder', children: [
                { id: '2-1', title: 'Asthma', type: 'folder', children: [
                    { id: '2-1-1', title: 'Diagnosis', type: 'file', content: 'Spirometry reversibility...' },
                    { id: '2-1-2', title: 'Management', type: 'file', content: 'Acute: O2, Nebs, Steroids. Chronic: Step-up therapy.' }
                ]},
                { id: '2-2', title: 'COPD', type: 'file', content: 'Smoking Hx, Irreversible obstruction...' }
            ]},
            { id: '3', title: '3. Renal', type: 'folder', children: [
                { id: '3-1', title: 'AKI', type: 'file', content: 'Prerenal, Intrinsic, Postrenal...' }
            ]},
            { id: '4', title: '4. Infectious Disease', type: 'folder', children: [
                { id: '4-1', title: 'General', type: 'file', content: 'PUO, Sepsis 6...' },
                { id: '4-2', title: 'Vector Borne', type: 'file', content: 'Dengue, Malaria...' }
            ]},
            { id: '5', title: '5. GIT & Liver', type: 'folder', children: [
                { id: '5-1', title: 'Hepatology', type: 'file', content: 'Cirrhosis, Portal HTN...' }
            ]},
            { id: '6', title: '6. Neurology', type: 'folder', children: [
                { id: '6-1', title: 'Stroke', type: 'file', content: 'Bamford Classification...' }
            ]}
        ];

        vaultData = initialData;
        await saveStructureToDB();
        renderTree(vaultData, document.getElementById('file-tree'));
        alert("Database initialized!");
    }

    // --- 5. RENDERER ---
    function renderTree(nodes, container, depth = 0) {
        container.innerHTML = '';
        nodes.forEach(node => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'tree-item';
            
            const icon = node.type === 'folder' 
                ? `<span class="arrow ${node.isOpen ? 'open' : ''}">‚ñ∂</span> üìÅ` 
                : `<span style="width:14px; display:inline-block"></span> üìÑ`;

            itemDiv.innerHTML = `
                <div style="display:flex; align-items:center; flex:1; padding-left:${depth * 12}px">
                    ${icon} <span style="margin-left:6px; font-weight:${node.type==='folder'?'600':'400'}">${node.title}</span>
                </div>
                <div class="node-controls">
                    ${node.type==='folder' ? `<button class="ctrl-btn" onclick="addFile('${node.id}', event)" title="New File">Ôºã</button>` : ''}
                    ${node.type==='folder' ? `<button class="ctrl-btn" onclick="addFolder('${node.id}', event)" title="New Folder">üóÇ</button>` : ''}
                    <button class="ctrl-btn" onclick="renameNode('${node.id}', event)" title="Rename">‚úé</button>
                    <button class="ctrl-btn del" onclick="deleteNode('${node.id}', event)" title="Delete">üóë</button>
                </div>
            `;

            itemDiv.onclick = (e) => {
                if (e.target.closest('.ctrl-btn')) return; 
                if (node.type === 'folder') {
                    node.isOpen = !node.isOpen;
                    saveStructureToDB(); 
                    renderTree(vaultData, document.getElementById('file-tree'));
                } else {
                    openNote(node);
                }
            };

            if (currentNoteId === node.id) itemDiv.classList.add('active');
            container.appendChild(itemDiv);

            if (node.type === 'folder' && node.isOpen && node.children) {
                const childrenContainer = document.createElement('div');
                renderTree(node.children, childrenContainer, depth + 1);
                container.appendChild(childrenContainer);
            }
        });
    }

    // --- 6. LOGIC ---
    function findNode(nodes, id) {
        for(let node of nodes) {
            if(node.id === id) return node;
            if(node.children) {
                let found = findNode(node.children, id);
                if(found) return found;
            }
        }
        return null;
    }

    function addFile(parentId, e) {
        e.stopPropagation();
        const parent = findNode(vaultData, parentId);
        const name = prompt("Name of new note:");
        if(name) {
            parent.children.push({ id: Date.now().toString(), title: name, type: 'file', content: '' });
            parent.isOpen = true;
            saveStructureToDB();
            renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    function addFolder(parentId, e) {
        e.stopPropagation();
        const parent = findNode(vaultData, parentId);
        const name = prompt("Name of new folder:");
        if(name) {
            parent.children.push({ id: Date.now().toString(), title: name, type: 'folder', isOpen: true, children: [] });
            parent.isOpen = true;
            saveStructureToDB();
            renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    function deleteNode(id, e) {
        e.stopPropagation();
        if(!confirm("Delete this item?")) return;
        
        function remove(nodes) {
            const idx = nodes.findIndex(n => n.id === id);
            if(idx > -1) { nodes.splice(idx, 1); return true; }
            for(let n of nodes) { if(n.children && remove(n.children)) return true; }
        }
        remove(vaultData);
        saveStructureToDB();
        renderTree(vaultData, document.getElementById('file-tree'));
        
        if(currentNoteId === id) {
            document.getElementById('editor').innerHTML = '';
            document.getElementById('note-title').value = '';
        }
    }

    function renameNode(id, e) {
        e.stopPropagation();
        const node = findNode(vaultData, id);
        const newName = prompt("Rename to:", node.title);
        if(newName) {
            node.title = newName;
            saveStructureToDB();
            renderTree(vaultData, document.getElementById('file-tree'));
            if(currentNoteId === id) document.getElementById('note-title').value = newName;
        }
    }

    async function openNote(node) {
        currentNoteId = node.id;
        document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
        renderTree(vaultData, document.getElementById('file-tree')); 
        
        document.getElementById('breadcrumbs').innerText = getBreadcrumbs(vaultData, node.id) || "Vault";
        document.getElementById('note-title').value = node.title;
        document.getElementById('editor').innerHTML = '<span style="color:#666">Loading...</span>';
        
        if(window.innerWidth <= 768) toggleSidebar();

        try {
            const doc = await db.collection('notes').doc(node.id).get();
            if(doc.exists) {
                const data = doc.data();
                document.getElementById('editor').innerHTML = data.content;
                node.content = data.content;
            } else {
                document.getElementById('editor').innerHTML = node.content || '';
            }
        } catch(e) {
            document.getElementById('editor').innerHTML = node.content || '';
        }
    }

    function getBreadcrumbs(nodes, id, path = '') {
        for(let node of nodes) {
            if(node.id === id) return path ? `${path} / ${node.title}` : node.title;
            if(node.children) {
                let found = getBreadcrumbs(node.children, id, path ? `${path} / ${node.title}` : node.title);
                if(found) return found;
            }
        }
        return null;
    }

    function handleSearch(e) {
        const query = e.target.value.toLowerCase();
        const tree = document.getElementById('file-tree');
        const resultsList = document.getElementById('search-results-list');

        if(query.length < 2) {
            tree.style.display = 'block';
            resultsList.style.display = 'none';
            return;
        }

        tree.style.display = 'none';
        resultsList.style.display = 'flex';
        resultsList.innerHTML = '';

        let results = [];
        function traverse(nodes, path) {
            nodes.forEach(n => {
                const currentPath = path ? `${path} > ${n.title}` : n.title;
                if(n.type === 'file') {
                    const titleMatch = n.title.toLowerCase().includes(query);
                    const contentMatch = n.content && n.content.toLowerCase().includes(query);
                    
                    if(titleMatch || contentMatch) {
                        let snippet = "";
                        if(contentMatch) {
                            const idx = n.content.toLowerCase().indexOf(query);
                            const start = Math.max(0, idx - 20);
                            const end = Math.min(n.content.length, idx + 50);
                            snippet = "..." + n.content.substring(start, end).replace(/<[^>]*>/g, '') + "...";
                        }
                        results.push({ node: n, path: currentPath, snippet });
                    }
                }
                if(n.children) traverse(n.children, currentPath);
            });
        }

        traverse(vaultData, "");

        if(results.length === 0) {
            resultsList.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No results found</div>';
        } else {
            results.forEach(res => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div class="result-path">${res.path}</div>
                    <div class="result-title">${res.node.title}</div>
                    ${res.snippet ? `<div class="result-snippet">${res.snippet}</div>` : ''}
                `;
                div.onclick = () => {
                    openNote(res.node);
                    document.getElementById('search-input').value = '';
                    tree.style.display = 'block';
                    resultsList.style.display = 'none';
                };
                resultsList.appendChild(div);
            });
        }
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('mode-toggle');
        const editor = document.getElementById('editor');
        const toolbar = document.getElementById('editor-toolbar');
        const titleInput = document.getElementById('note-title');

        if(isEditMode) {
            btn.innerText = 'Editing...';
            btn.classList.add('active');
            editor.contentEditable = true;
            titleInput.removeAttribute('readonly');
            toolbar.classList.add('visible');
        } else {
            btn.innerText = 'Read Only';
            btn.classList.remove('active');
            editor.contentEditable = false;
            titleInput.setAttribute('readonly', true);
            toolbar.classList.remove('visible');
            if(currentNoteId) saveNoteContent(currentNoteId);
        }
    }

    function fmt(cmd, val) {
        document.execCommand(cmd, false, val);
        document.getElementById('editor').focus();
    }
    function insertLink() { const url = prompt("URL:"); if(url) fmt('createLink', url); }
    function insertImage() { const url = prompt("Image URL:"); if(url) fmt('insertHTML', `<img src="${url}">`); }
    function insertVideo() { 
        const url = prompt("YouTube URL:"); 
        if(url) {
            const videoId = url.split('v=')[1]?.split('&')[0];
            if(videoId) fmt('insertHTML', `<div style="position:relative; padding-bottom:56.25%; height:0;"><iframe src="https://www.youtube.com/embed/${videoId}" style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" allowfullscreen></iframe></div><p><br></p>`);
        }
    }

    function toggleDropdown() {
        const d = document.getElementById("settings-dropdown");
        d.style.display = d.style.display === "block" ? "none" : "block";
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vaultData));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "im_vault_backup.json";
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(file, 'UTF-8');
            reader.onload = readerEvent => {
                try {
                    vaultData = JSON.parse(readerEvent.target.result);
                    saveStructureToDB();
                    renderTree(vaultData, document.getElementById('file-tree'));
                    alert("Import Successful");
                } catch(err) { alert("Invalid JSON"); }
            }
        }
        input.click();
    }

    function toggleSidebar() {
        const sb = document.getElementById('app-sidebar');
        sb.classList.toggle('open');
        document.getElementById('backdrop').style.display = sb.classList.contains('open') ? 'block' : 'none';
    }
    function closeSidebar() {
        document.getElementById('app-sidebar').classList.remove('open');
        document.getElementById('backdrop').style.display = 'none';
    }
    function toggleAllFolders(state) {
        function toggle(nodes) { nodes.forEach(n => { if(n.type==='folder') { n.isOpen = state; if(n.children) toggle(n.children); } }); }
        toggle(vaultData);
        renderTree(vaultData, document.getElementById('file-tree'));
    }
    function focusEditor() { if(isEditMode) document.getElementById('editor').focus(); }
</script>

</body>
</html>
