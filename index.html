<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>IM Curriculum Tracker V5</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- 1. CSS VARIABLES --- */
        :root {
            --bg-body: #09090b; --bg-sidebar: #101012; 
            --text-main: #e4e4e7; --text-muted: #a1a1aa; 
            --accent-color: #8b5cf6; --accent-hover: #7c3aed;
            --danger: #ef4444; --success: #22c55e;
            --border-color: #27272a; 
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --header-height: 60px;
        }

        /* --- 2. RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main);
            height: 100vh; display: flex; overflow: hidden; font-size: 14px;
        }

        /* --- 3. SIDEBAR (Modernized) --- */
        aside {
            width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 100; flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header { 
            padding: 16px; border-bottom: 1px solid var(--border-color); 
            display: flex; flex-direction: column; gap: 12px; background: var(--bg-sidebar);
        }

        .header-controls { display: flex; justify-content: space-between; align-items: center; }
        .app-logo { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; color: #fff; }

        .btn-group { display: flex; gap: 8px; }
        .btn-xs {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #333;
            background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600;
            transition: all 0.2s; text-transform: uppercase;
        }
        .btn-xs:hover { border-color: #555; color: #fff; }
        .btn-xs.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        .btn-xs.danger.active { background: var(--danger); border-color: var(--danger); }

        /* Search */
        .search-wrapper { position: relative; }
        #sidebar-search {
            width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #333;
            background: #18181b; color: white; font-size: 0.85rem;
        }
        #sidebar-search:focus { border-color: var(--accent-color); }
        
        #search-results {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
            max-height: 300px; overflow-y: auto; background: #18181b; 
            border: 1px solid #333; border-radius: 0 0 6px 6px; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .search-item { 
            padding: 8px 12px; border-bottom: 1px solid #222; cursor: pointer; 
            display: flex; flex-direction: column; gap: 2px;
        }
        .search-item:hover { background: #27272a; }
        .search-path { font-size: 0.7rem; color: var(--text-muted); }
        .search-title { font-weight: 600; font-size: 0.85rem; color: #fff; }

        /* Tree Container */
        .tree-scroll { flex: 1; overflow-y: auto; padding: 10px 0 40px 0; }
        
        /* Tree Node Styles */
        .tree-node { position: relative; }
        .tree-content {
            display: flex; align-items: center; padding: 6px 12px; cursor: pointer;
            color: var(--text-muted); border-left: 2px solid transparent; gap: 8px;
            transition: background 0.1s;
        }
        .tree-content:hover { background: #18181b; color: #fff; }
        .tree-content.active { 
            background: rgba(139, 92, 246, 0.15); color: #fff; 
            border-left-color: var(--accent-color); 
        }

        .tree-icon { width: 14px; text-align: center; font-size: 0.8rem; display: inline-block; }
        .tree-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tree-toggle { 
            width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; 
            transition: transform 0.2s; font-size: 0.7rem; color: #666;
        }
        .tree-toggle.rotated { transform: rotate(90deg); color: #fff; }

        /* Nested Children */
        .tree-children { 
            display: none; margin-left: 19px; border-left: 1px solid #333; 
        }
        .tree-children.open { display: block; }

        /* Sidebar Edit Controls */
        .node-actions { display: none; gap: 4px; margin-left: 4px; }
        .sidebar-editing .node-actions { display: flex; }
        .action-btn {
            width: 18px; height: 18px; border-radius: 3px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff;
        }
        .btn-add { background: #333; } .btn-add:hover { background: var(--success); }
        .btn-del { background: #333; } .btn-del:hover { background: var(--danger); }

        /* --- 4. MAIN EDITOR --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); width: 100%; position: relative; }

        .mobile-header {
            display: none; height: var(--header-height); border-bottom: 1px solid var(--border-color);
            align-items: center; padding: 0 16px; background: rgba(9,9,11,0.9); backdrop-filter: blur(10px);
            justify-content: space-between; flex-shrink: 0;
        }

        .editor-container { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .editor-scroll { flex: 1; overflow-y: auto; padding: 2rem 10% 8rem 10%; }

        .note-meta { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .breadcrumbs { font-size: 0.75rem; color: var(--accent-color); margin-bottom: 0.5rem; font-family: var(--font-mono); text-transform: uppercase; }
        .note-title { 
            width: 100%; background: transparent; border: none; font-size: 2rem; font-weight: 800; color: #fff; 
            font-family: var(--font-main); margin-bottom: 10px;
        }

        /* Editor Content */
        .editor-content { min-height: 60vh; font-size: 1.05rem; line-height: 1.7; color: #d4d4d4; white-space: pre-wrap; outline: none; }
        .editor-content:empty:before { content: 'Select a topic or create one...'; color: #444; }
        .editor-content h1, h2, h3 { color: #fff; margin-top: 1.5em; margin-bottom: 0.5em; }
        .editor-content h2 { border-bottom: 1px solid #333; padding-bottom: 0.3em; color: var(--accent-color); }
        .editor-content a { color: var(--accent-color); text-decoration: underline; }
        .editor-content img { max-width: 100%; border-radius: 8px; border: 1px solid #333; }

        /* --- 5. RESPONSIVE --- */
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; backdrop-filter: blur(2px); }

        @media (max-width: 900px) {
            .editor-scroll { padding: 2rem 1.2rem 8rem 1.2rem; }
            .mobile-header { display: flex; }
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 85%; box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
            aside.open { transform: translateX(0); }
            .backdrop.open { display: block; }
        }

        /* --- 6. TOOLBAR --- */
        .toolbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 550px; background: rgba(24,24,27,0.95);
            backdrop-filter: blur(10px); border: 1px solid #333; border-radius: 12px;
            padding: 8px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: none; gap: 5px; overflow-x: auto;
        }
        .toolbar.visible { display: flex; }
        
        .tool-btn { 
            flex: 0 0 auto; width: 36px; height: 36px; border-radius: 6px; border: none; 
            background: #27272a; color: #a1a1aa; cursor: pointer; font-weight: bold; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: #3f3f46; color: white; }
        .tool-btn.active { background: var(--accent-color); color: white; }
    </style>
</head>
<body>

    <div class="backdrop" id="backdrop" onclick="closeSidebar()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="header-controls">
                <div class="app-logo">IM Curriculum V5</div>
                <div class="btn-group">
                    <button id="btnEditSidebar" class="btn-xs" onclick="toggleSidebarEdit()">Edit Sidebar</button>
                    <button id="btnEditNote" class="btn-xs" onclick="toggleNoteEdit()">Read Only</button>
                </div>
            </div>
            <div class="search-wrapper">
                <input type="text" id="sidebar-search" placeholder="Search notes...">
                <div id="search-results"></div>
            </div>
        </div>
        
        <div id="tree-root" class="tree-scroll">
            </div>
    </aside>

    <main>
        <div class="mobile-header">
            <button onclick="openSidebar()" style="background:none; border:none; color:white; font-size:1.5rem;">‚ò∞</button>
            <div style="font-weight:700; color:white;">IM Notes</div>
            <div style="width:24px"></div>
        </div>

        <div class="editor-container">
            <div class="editor-scroll">
                <div class="note-meta">
                    <div id="breadcrumbs" class="breadcrumbs">Start</div>
                    <input type="text" id="noteTitle" class="note-title" placeholder="No Topic Selected" readonly>
                </div>
                <div id="editor" class="editor-content" spellcheck="false"></div>
            </div>
        </div>
    </main>

    <div class="toolbar" id="toolbar">
        <button class="tool-btn" data-cmd="undo">‚Ü∫</button>
        <button class="tool-btn" data-cmd="redo">‚Üª</button>
        <div style="width:1px; background:#444; margin:0 4px;"></div>
        <button class="tool-btn" data-cmd="bold">B</button>
        <button class="tool-btn" data-cmd="italic">I</button>
        <button class="tool-btn" data-cmd="underline">U</button>
        <div style="width:1px; background:#444; margin:0 4px;"></div>
        <button class="tool-btn" data-cmd="formatBlock" data-val="H2">H2</button>
        <button class="tool-btn" data-cmd="formatBlock" data-val="H3">H3</button>
        <button class="tool-btn" data-cmd="insertUnorderedList">‚Ä¢</button>
        <div style="width:1px; background:#444; margin:0 4px;"></div>
        <button class="tool-btn" id="btn-link">üîó</button>
        <button class="tool-btn" id="btn-img">üñºÔ∏è</button>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:80d03d582a3384746f4e55"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. GLOBAL STATE ---
        let currentNoteId = null;
        let isSidebarEditing = false;
        let isNoteEditing = false;
        
        // --- 3. DATA STRUCTURE (Recursive) ---
        // type: 'folder' or 'file'
        // content: only for files
        // children: array for folders
        let treeData = [
            {
                id: "cvs", title: "1. Cardiovascular", type: "folder", isOpen: true, children: [
                    {
                        id: "cvs-hx-exam", title: "History & Examination", type: "folder", children: [
                            {
                                id: "cvs-hx-taking", title: "History Taking", type: "folder", children: [
                                    [cite_start]{ id: "cvs-sx-grading", title: "Grading Effort Intolerance [cite: 2]", type: "file", content: "NYHA Classification I-IV details here..." },
                                    [cite_start]{ id: "cvs-sx-sob", title: "SOB / Orthopnoea / PND [cite: 2]", type: "file", content: "Details on shortness of breath patterns..." },
                                    [cite_start]{ id: "cvs-sx-pain", title: "Chest Pain [cite: 2]", type: "file", content: "SOCRATES method for chest pain..." }
                                ]
                            },
                            {
                                id: "cvs-risks", title: "Risk Factors", type: "folder", children: [
                                    [cite_start]{ id: "cvs-rf-ivdu", title: "IVDU & Rheumatic Fever [cite: 2]", type: "file", content: "Infective endocarditis risks..." },
                                    [cite_start]{ id: "cvs-rf-cad", title: "CAD Risk Factors [cite: 2]", type: "file", content: "Diabetes, HTN, Smoking, Lipids..." }
                                ]
                            },
                            {
                                id: "cvs-pe", title: "Physical Exam", type: "folder", children: [
                                    [cite_start]{ id: "cvs-pe-hands", title: "Hands (Clubbing/Splinter) [cite: 2]", type: "file", content: "Signs of IE in hands..." },
                                    [cite_start]{ id: "cvs-pe-precord", title: "Precordium (JVP/Apex) [cite: 2]", type: "file", content: "JVP measurement, Apex beat character..." }
                                ]
                            }
                        ]
                    },
                    {
                        id: "cvs-htn", title: "Hypertension", type: "folder", children: [
                             [cite_start]{ id: "htn-def", title: "Definitions & Target Organ [cite: 2]", type: "file", content: "Stage 1, Stage 2, Hypertensive urgency..." },
                             [cite_start]{ id: "htn-sec", title: "Secondary Causes [cite: 2]", type: "file", content: "Renal artery stenosis, Conn's, etc..." }
                        ]
                    }
                ]
            },
            {
                id: "resp", title: "2. Respiratory", type: "folder", children: [
                    { id: "asthma", title: "Bronchial Asthma", type: "folder", children: [
                        [cite_start]{ id: "asthma-dx", title: "Diagnosis & Ddx [cite: 4]", type: "file", content: "Reversibility testing..." },
                        [cite_start]{ id: "asthma-acute", title: "Acute Exacerbation [cite: 4]", type: "file", content: "O2, Nebs, Steroids..." }
                    ]}
                ]
            },
            {
                id: "renal", title: "3. Renal System", type: "folder", children: [
                    { id: "aki", title: "Acute Kidney Injury", type: "folder", children: [
                         [cite_start]{ id: "aki-types", title: "Prerenal / Intrinsic / Post [cite: 10]", type: "file", content: "..."}
                    ]}
                ]
            }
        ];

        // --- 4. INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTree(treeData, document.getElementById('tree-root'));
            
            // Listeners
            document.getElementById('editor').addEventListener('input', debounce(saveNote, 1000));
            document.getElementById('sidebar-search').addEventListener('input', handleSearch);
            
            // Toolbar
            const editor = document.getElementById('editor');
            editor.addEventListener('mouseup', updateToolbarState);
            editor.addEventListener('keyup', updateToolbarState);
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('mousedown', (e) => e.preventDefault()); // prevent losing focus
                btn.addEventListener('click', handleToolbarAction);
            });

            // Viewport keyboard fix
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const toolbar = document.getElementById('toolbar');
                    if (isNoteEditing && window.visualViewport.height < window.innerHeight) {
                        toolbar.style.bottom = `${window.innerHeight - window.visualViewport.height + 10}px`;
                    } else {
                        toolbar.style.bottom = '20px';
                    }
                });
            }
        });

        // --- 5. RECURSIVE TREE RENDERER ---
        function renderTree(nodes, container, depth = 0) {
            container.innerHTML = '';
            
            nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'tree-node';
                
                // Content Row
                const contentEl = document.createElement('div');
                contentEl.className = `tree-content ${currentNoteId === node.id ? 'active' : ''}`;
                contentEl.style.paddingLeft = `${12 + (depth * 14)}px`;
                contentEl.dataset.id = node.id;
                
                // Click handlers
                contentEl.onclick = (e) => handleNodeClick(e, node);

                // Icon logic
                let iconHtml = '';
                if (node.type === 'folder') {
                    iconHtml = `<div class="tree-toggle ${node.isOpen ? 'rotated' : ''}">‚ñ∂</div>`;
                    iconHtml += `<div class="tree-icon">${node.isOpen ? 'üìÇ' : 'üìÅ'}</div>`;
                } else {
                    iconHtml = `<div class="tree-toggle"></div>`; // Spacer
                    iconHtml += `<div class="tree-icon">üìÑ</div>`;
                }

                // Title (Editable if sidebar edit mode)
                let titleHtml = `<div class="tree-label">${node.title}</div>`;

                // Edit Buttons (Add/Del)
                let actionsHtml = `
                    <div class="node-actions">
                        ${node.type === 'folder' ? `<button class="action-btn btn-add" onclick="addNode('${node.id}', event)">+</button>` : ''}
                        <button class="action-btn btn-del" onclick="deleteNode('${node.id}', event)">x</button>
                    </div>
                `;

                contentEl.innerHTML = `${iconHtml}${titleHtml}${actionsHtml}`;
                nodeEl.appendChild(contentEl);

                // Children Container
                if (node.children) {
                    const childrenEl = document.createElement('div');
                    childrenEl.className = `tree-children ${node.isOpen ? 'open' : ''}`;
                    // Recursive call
                    renderTree(node.children, childrenEl, depth + 1);
                    nodeEl.appendChild(childrenEl);
                }

                container.appendChild(nodeEl);
            });
            
            // Add "Root" add button if at top level and editing
            if (depth === 0 && isSidebarEditing) {
                const addRootBtn = document.createElement('div');
                addRootBtn.style.padding = "10px";
                addRootBtn.innerHTML = `<button class="btn-xs" style="width:100%" onclick="addRootNode()">+ Add New Topic</button>`;
                container.appendChild(addRootBtn);
            }
        }

        // --- 6. TREE INTERACTION ---
        function handleNodeClick(e, node) {
            if (e.target.closest('.action-btn')) return; // Ignore if clicked delete/add

            if (node.type === 'folder') {
                node.isOpen = !node.isOpen;
                renderTree(treeData, document.getElementById('tree-root'));
            } else {
                loadNote(node);
            }
        }

        function findNode(nodes, id) {
            for (let node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNode(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- 7. SIDEBAR EDITING LOGIC ---
        function toggleSidebarEdit() {
            isSidebarEditing = !isSidebarEditing;
            const btn = document.getElementById('btnEditSidebar');
            const sidebar = document.getElementById('sidebar');
            
            btn.innerText = isSidebarEditing ? 'Done' : 'Edit Sidebar';
            btn.classList.toggle('active', isSidebarEditing);
            
            if (isSidebarEditing) sidebar.classList.add('sidebar-editing');
            else sidebar.classList.remove('sidebar-editing');
            
            // Re-render to show/hide buttons
            renderTree(treeData, document.getElementById('tree-root'));
        }

        function addNode(parentId, e) {
            e.stopPropagation();
            const parent = findNode(treeData, parentId);
            if (!parent) return;

            const title = prompt("Name of new item:");
            if (!title) return;

            const type = confirm("Create a FOLDER? (Cancel for FILE)") ? 'folder' : 'file';
            
            const newNode = {
                id: Date.now().toString(),
                title: title,
                type: type,
                children: type === 'folder' ? [] : undefined,
                content: type === 'file' ? "Start typing..." : undefined,
                isOpen: true
            };

            parent.children.push(newNode);
            parent.isOpen = true; // Ensure open
            renderTree(treeData, document.getElementById('tree-root'));
            // Save tree state (mock)
            console.log("Tree updated", treeData);
        }

        function addRootNode() {
            const title = prompt("Name of new Root Topic:");
            if (!title) return;
            
            treeData.push({
                id: Date.now().toString(),
                title: title,
                type: 'folder',
                children: [],
                isOpen: true
            });
            renderTree(treeData, document.getElementById('tree-root'));
        }

        function deleteNode(id, e) {
            e.stopPropagation();
            if (!confirm("Delete this item?")) return;
            
            function removeRecursive(nodes) {
                const idx = nodes.findIndex(n => n.id === id);
                if (idx > -1) {
                    nodes.splice(idx, 1);
                    return true;
                }
                for (let node of nodes) {
                    if (node.children && removeRecursive(node.children)) return true;
                }
                return false;
            }
            
            removeRecursive(treeData);
            renderTree(treeData, document.getElementById('tree-root'));
            
            if (currentNoteId === id) {
                document.getElementById('editor').innerHTML = '';
                document.getElementById('noteTitle').value = '';
                currentNoteId = null;
            }
        }

        // --- 8. NOTE LOGIC ---
        async function loadNote(node) {
            currentNoteId = node.id;
            
            // Highlight sidebar
            document.querySelectorAll('.tree-content').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.tree-content[data-id="${node.id}"]`);
            if (activeEl) activeEl.classList.add('active');

            // Mobile handling
            if (window.innerWidth <= 900) closeSidebar();

            // Breadcrumbs (Simple version, ideally recursive find parent)
            document.getElementById('breadcrumbs').innerText = "Viewing Note";
            document.getElementById('noteTitle').value = node.title;
            
            document.getElementById('editor').innerHTML = '<span style="color:#666">Loading...</span>';

            // 1. Check local tree data first (newly created notes)
            if (node.content && node.content !== "Start typing...") {
                document.getElementById('editor').innerHTML = node.content;
            } else {
                // 2. Try Firebase
                try {
                    const doc = await db.collection('notes').doc(node.id).get();
                    if (doc.exists) {
                        document.getElementById('editor').innerHTML = doc.data().content;
                    } else {
                        document.getElementById('editor').innerHTML = node.content || '';
                    }
                } catch (e) {
                    document.getElementById('editor').innerHTML = node.content || '';
                }
            }
        }

        async function saveNote() {
            if (!currentNoteId) return;
            const content = document.getElementById('editor').innerHTML;
            
            // Update local tree
            const node = findNode(treeData, currentNoteId);
            if (node) node.content = content;

            // Save to Firebase
            await db.collection('notes').doc(currentNoteId).set({
                content: content,
                lastUpdated: new Date()
            }, { merge: true });
        }

        // --- 9. NOTE EDITING TOGGLE ---
        function toggleNoteEdit() {
            isNoteEditing = !isNoteEditing;
            const btn = document.getElementById('btnEditNote');
            const editor = document.getElementById('editor');
            const toolbar = document.getElementById('toolbar');

            editor.contentEditable = isNoteEditing;
            btn.innerText = isNoteEditing ? 'Edit On' : 'Read Only';
            btn.classList.toggle('active', isNoteEditing);
            btn.classList.toggle('danger', isNoteEditing); // Visual Cue

            if (isNoteEditing) toolbar.classList.add('visible');
            else toolbar.classList.remove('visible');
        }

        // --- 10. SEARCH LOGIC (Updated to index live Tree) ---
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsBox = document.getElementById('search-results');
            resultsBox.innerHTML = '';
            
            if (query.length < 2) {
                resultsBox.style.display = 'none';
                return;
            }

            let results = [];
            
            function traverseSearch(nodes, path) {
                nodes.forEach(node => {
                    const currentPath = path ? `${path} > ${node.title}` : node.title;
                    
                    // Match Title
                    if (node.title.toLowerCase().includes(query)) {
                        results.push({ node, path: currentPath, type: 'Title Match' });
                    } 
                    // Match Content (only files)
                    else if (node.type === 'file' && node.content && node.content.toLowerCase().includes(query)) {
                        results.push({ node, path: currentPath, type: 'Content Match' });
                    }

                    if (node.children) traverseSearch(node.children, currentPath);
                });
            }

            traverseSearch(treeData, "");

            if (results.length > 0) {
                resultsBox.style.display = 'block';
                results.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `
                        <div class="search-path">${res.path}</div>
                        <div class="search-title">${res.node.title}</div>
                    `;
                    div.onclick = () => {
                        if (res.node.type === 'file') {
                            loadNote(res.node);
                        } else {
                            // Expand folder if matched (simple implementation: just alert or log)
                            alert("Found Folder: " + res.node.title + ". Expand in tree to view.");
                        }
                        resultsBox.style.display = 'none';
                        document.getElementById('sidebar-search').value = '';
                    };
                    resultsBox.appendChild(div);
                });
            } else {
                resultsBox.style.display = 'block';
                resultsBox.innerHTML = '<div style="padding:10px; color:#666; text-align:center">No results</div>';
            }
        }

        // --- 11. TOOLBAR & UTILS ---
        function handleToolbarAction(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            const cmd = btn.dataset.cmd;
            const val = btn.dataset.val;
            const id = btn.id;

            if (id === 'btn-link') {
                const url = prompt("URL:");
                if(url) document.execCommand('createLink', false, url);
            } else if (id === 'btn-img') {
                const url = prompt("Image URL:");
                if(url) document.execCommand('insertHTML', false, `<img src="${url}">`);
            } else {
                document.execCommand(cmd, false, val);
            }
            updateToolbarState();
        }

        function updateToolbarState() {
            document.querySelectorAll('[data-cmd]').forEach(btn => {
                const cmd = btn.dataset.cmd;
                try {
                    if (document.queryCommandState(cmd)) btn.classList.add('active');
                    else btn.classList.remove('active');
                } catch(e){}
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('backdrop').classList.add('open');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('backdrop').classList.remove('open');
        }

    </script>
</body>
</html>
