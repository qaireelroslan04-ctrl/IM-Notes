<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>IM Curriculum V6</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- 1. CSS VARIABLES --- */
        :root {
            --bg-body: #09090b; --bg-sidebar: #101012; 
            --text-main: #e4e4e7; --text-muted: #a1a1aa; 
            --accent-color: #8b5cf6; 
            --danger: #ef4444; --success: #22c55e;
            --border-color: #27272a; 
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --header-height: 50px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main);
            height: 100vh; display: flex; overflow: hidden; font-size: 14px;
        }

        /* --- 2. SIDEBAR --- */
        aside {
            width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 100; flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header { 
            padding: 12px; border-bottom: 1px solid var(--border-color); 
            display: flex; flex-direction: column; gap: 10px; background: var(--bg-sidebar);
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .app-logo { font-weight: 800; font-size: 1rem; color: #fff; }

        /* Small Buttons */
        .btn-xs {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #333;
            background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600;
            text-transform: uppercase; transition: all 0.2s;
        }
        .btn-xs:hover { border-color: #555; color: #fff; }
        .btn-xs.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        
        /* Search */
        #sidebar-search {
            width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #333;
            background: #18181b; color: white; font-size: 0.85rem;
        }
        
        #search-results {
            max-height: 200px; overflow-y: auto; background: #18181b; 
            border: 1px solid #333; display: none; margin-top: 5px; border-radius: 4px;
        }
        .search-item { padding: 6px 10px; border-bottom: 1px solid #222; cursor: pointer; }
        .search-item:hover { background: #27272a; }
        .search-path { font-size: 0.7rem; color: var(--text-muted); }

        .tree-scroll { flex: 1; overflow-y: auto; padding: 10px 0 40px 0; }
        
        /* Tree Nodes */
        .tree-node { position: relative; }
        .tree-content {
            display: flex; align-items: center; padding: 4px 12px; cursor: pointer;
            color: var(--text-muted); border-left: 2px solid transparent; gap: 6px;
        }
        .tree-content:hover { background: #18181b; color: #fff; }
        .tree-content.active { 
            background: rgba(139, 92, 246, 0.1); color: #fff; 
            border-left-color: var(--accent-color); 
        }

        .tree-toggle { width: 14px; text-align: center; font-size: 0.7rem; color: #555; transition: 0.2s; }
        .tree-toggle.rotated { transform: rotate(90deg); color: #fff; }
        .tree-icon { font-size: 0.9rem; }
        .tree-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .tree-children { display: none; margin-left: 10px; border-left: 1px solid #222; }
        .tree-children.open { display: block; }

        /* Sidebar Edit Actions */
        .node-actions { display: none; gap: 4px; margin-left: auto; }
        .sidebar-editing .node-actions { display: flex; }
        .action-btn {
            width: 16px; height: 16px; border-radius: 2px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff;
        }
        .btn-add { background: #333; } .btn-add:hover { background: var(--success); }
        .btn-del { background: #333; } .btn-del:hover { background: var(--danger); }

        /* --- 3. MAIN AREA --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); position: relative; }

        .mobile-header {
            display: none; height: 50px; border-bottom: 1px solid var(--border-color);
            align-items: center; padding: 0 16px; background: #18181b;
            justify-content: space-between; flex-shrink: 0;
        }

        .editor-container { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .editor-scroll { flex: 1; overflow-y: auto; padding: 2rem 10% 8rem 10%; }

        /* Note Header (Location 2 for Edit Button) */
        .note-header-area {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;
        }
        .note-info { flex: 1; }
        .breadcrumbs { font-size: 0.75rem; color: var(--accent-color); margin-bottom: 0.5rem; text-transform: uppercase; }
        .note-title { 
            width: 100%; background: transparent; border: none; font-size: 1.8rem; font-weight: 800; color: #fff; 
            font-family: var(--font-main);
        }

        /* Editor */
        .editor-content { min-height: 60vh; font-size: 1.05rem; line-height: 1.7; color: #d4d4d4; white-space: pre-wrap; outline: none; }
        .editor-content[contenteditable="false"] { opacity: 0.9; }
        .editor-content h2 { margin-top: 1.5em; border-bottom: 1px solid #333; color: var(--accent-color); }
        .editor-content img { max-width: 100%; border: 1px solid #333; border-radius: 6px; }

        /* --- 4. TOOLBAR --- */
        .toolbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: #18181b; border: 1px solid #333; 
            border-radius: 8px; padding: 8px; z-index: 200; display: none; gap: 5px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); overflow-x: auto;
        }
        .toolbar.visible { display: flex; }
        .tool-btn { 
            flex: 0 0 auto; width: 32px; height: 32px; border-radius: 4px; border: none; 
            background: #27272a; color: #aaa; cursor: pointer; font-weight: bold;
        }
        .tool-btn.active { background: var(--accent-color); color: white; }

        /* Responsive */
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; }
        @media (max-width: 900px) {
            .mobile-header { display: flex; }
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 85%; }
            aside.open { transform: translateX(0); }
            .backdrop.open { display: block; }
            .editor-scroll { padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="backdrop" id="backdrop" onclick="closeSidebar()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="header-row">
                <div class="app-logo">IM Curriculum</div>
                <button id="btnEditSidebar" class="btn-xs" onclick="toggleSidebarEdit()">Edit Sidebar</button>
            </div>
            <input type="text" id="sidebar-search" placeholder="Search...">
            <div id="search-results"></div>
        </div>
        <div id="tree-root" class="tree-scroll"></div>
    </aside>

    <main>
        <div class="mobile-header">
            <button onclick="openSidebar()" style="background:none; border:none; color:white; font-size:1.5rem;">‚ò∞</button>
            <div style="font-weight:700; color:white;">IM Notes</div>
            <div style="width:24px"></div>
        </div>

        <div class="editor-container">
            <div class="editor-scroll">
                <div class="note-header-area">
                    <div class="note-info">
                        <div id="breadcrumbs" class="breadcrumbs">Select a topic</div>
                        <input type="text" id="noteTitle" class="note-title" placeholder="No Note Selected" readonly>
                    </div>
                    <button id="btnEditNote" class="btn-xs" onclick="toggleNoteEdit()">Read Only</button>
                </div>
                <div id="editor" class="editor-content" spellcheck="false"></div>
            </div>
        </div>
    </main>

    <div class="toolbar" id="toolbar">
        <button class="tool-btn" data-cmd="bold">B</button>
        <button class="tool-btn" data-cmd="italic">I</button>
        <button class="tool-btn" data-cmd="underline">U</button>
        <button class="tool-btn" data-cmd="formatBlock" data-val="H2">H2</button>
        <button class="tool-btn" data-cmd="insertUnorderedList">‚Ä¢</button>
        <button class="tool-btn" id="btn-link">üîó</button>
        <button class="tool-btn" id="btn-img">üñºÔ∏è</button>
    </div>

    <script>
        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:80d03d582a3384746f4e55"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DATA STRUCTURE (Parsed from PDF ) ---
        // Deeply nested: Folder -> Folder -> File
        let treeData = [
            {
                id: "1", title: "1. Cardiovascular", type: "folder", isOpen: false, children: [
                    { id: "1-1", title: "History & Exam", type: "folder", children: [
                        { id: "1-1-1", title: "History Taking", type: "folder", children: [
                            { id: "1-1-1-a", title: "Symptoms", type: "file", content: "<b>Grading effort intolerance:</b> NYHA Class I-IV.<br><b>SOB:</b> Orthopnoea, PND.<br><b>Pain:</b> Chest pain character.<br><b>Others:</b> Palpitations, Syncope." },
                            { id: "1-1-1-b", title: "Risk Factors", type: "file", content: "IVDU, Rheumatic fever history, CAD risks (Smoking, DM, HTN, Lipids)." }
                        ]},
                        { id: "1-1-2", title: "Physical Exam", type: "folder", children: [
                             { id: "1-1-2-a", title: "General", type: "file", content: "Clubbing, Cyanosis, Splinter haemorrhages (IE), Pallor." },
                             { id: "1-1-2-b", title: "Precordium", type: "file", content: "Apex beat, Heaves, Thrills, Murmurs." }
                        ]}
                    ]},
                    { id: "1-2", title: "Hypertension", type: "folder", children: [
                        { id: "1-2-1", title: "Basics", type: "file", content: "Definitions, Target Organ Damage." },
                        { id: "1-2-2", title: "Secondary HTN", type: "file", content: "Renal artery stenosis, Conn's, Cushing's." }
                    ]},
                    { id: "1-3", title: "Ischaemic Heart Disease", type: "folder", children: [
                        { id: "1-3-1", title: "Acute Coronary Syndrome", type: "file", content: "STEMI vs NSTEMI vs UA. Management algorithm." },
                        { id: "1-3-2", title: "Investigations", type: "file", content: "Stress test, Angiography." }
                    ]},
                    { id: "1-4", title: "Heart Failure", type: "folder", children: [
                        { id: "1-4-1", title: "Types", type: "file", content: "Acute vs Chronic. HFpEF." },
                        { id: "1-4-2", title: "Management", type: "file", content: "BB, ACEi, MRA, SGLT2i." }
                    ]}
                ]
            },
            {
                id: "2", title: "2. Respiratory", type: "folder", isOpen: false, children: [
                    { id: "2-1", title: "Asthma", type: "folder", children: [
                        { id: "2-1-1", title: "Diagnosis", type: "file", content: "Spirometry reversibility." },
                        { id: "2-1-2", title: "Acute Exacerbation", type: "file", content: "O2, Salbutamol, Ipratropium, Steroids." }
                    ]},
                    { id: "2-2", title: "COPD", type: "folder", children: [
                        { id: "2-2-1", title: "Diagnosis", type: "file", content: "Smoking Hx, Irreversible obstruction." },
                        { id: "2-2-2", title: "Management", type: "file", content: "LAMA, LABA, ICS." }
                    ]},
                    { id: "2-3", title: "Infections", type: "folder", children: [
                        { id: "2-3-1", title: "Pneumonia", type: "file", content: "CURB-65 Score. Antibiotics." },
                        { id: "2-3-2", title: "Tuberculosis", type: "file", content: "Screening (Mantoux). Treatment (DOTS)." }
                    ]}
                ]
            },
            {
                id: "3", title: "3. Renal", type: "folder", isOpen: false, children: [
                    { id: "3-1", title: "AKI", type: "folder", children: [
                        { id: "3-1-1", title: "Causes", type: "file", content: "Prerenal, Intrinsic, Postrenal." },
                        { id: "3-1-2", title: "Management", type: "file", content: "Fluid balance, Dialysis indications." }
                    ]},
                    { id: "3-2", title: "CKD", type: "file", content: "Staging 1-5. Complications (Bone, Anaemia)." }
                ]
            },
            {
                id: "4", title: "4. Infectious Disease", type: "folder", isOpen: false, children: [
                    { id: "4-1", title: "General", type: "file", content: "PUO, Sepsis 6." },
                    { id: "4-2", title: "Vector Borne", type: "folder", children: [
                        { id: "4-2-1", title: "Dengue", type: "file", content: "Febrile, Critical, Recovery phases." },
                        { id: "4-2-2", title: "Malaria", type: "file", content: "Plasmodium types. Severe malaria signs." }
                    ]}
                ]
            },
            {
                id: "5", title: "5. GIT & Liver", type: "folder", isOpen: false, children: [
                    { id: "5-1", title: "Hepatology", type: "folder", children: [
                        { id: "5-1-1", title: "Cirrhosis", type: "file", content: "Stigmata of CLD. Child-Pugh." },
                        { id: "5-1-2", title: "Portal HTN", type: "file", content: "Varices, Ascites." }
                    ]}
                ]
            },
            {
                id: "6", title: "6. Neurology", type: "folder", isOpen: false, children: [
                    { id: "6-1", title: "Stroke", type: "file", content: "Bamford Classification. Thrombolysis." },
                    { id: "6-2", title: "Epilepsy", type: "file", content: "Seizure types. Status Epilepticus." }
                ]
            },
            {
                id: "7", title: "7. Endocrinology", type: "folder", isOpen: false, children: [
                    { id: "7-1", title: "Diabetes", type: "file", content: "DKA vs HHS. Chronic complications." },
                    { id: "7-2", title: "Thyroid", type: "file", content: "Graves vs Hashimoto." }
                ]
            },
            {
                id: "8", title: "8. Haematology", type: "folder", isOpen: false, children: [
                    { id: "8-1", title: "Anaemia", type: "file", content: "Thalassaemia, Iron deficiency." },
                    { id: "8-2", title: "Malignancy", type: "file", content: "Leukaemia, Lymphoma." }
                ]
            },
            {
                id: "9", title: "9. Rheumatology", type: "folder", isOpen: false, children: [
                    { id: "9-1", title: "Joints", type: "file", content: "RA vs OA vs Gout." },
                    { id: "9-2", title: "SLE", type: "file", content: "Diagnostic criteria." }
                ]
            }
        ];

        // --- STATE ---
        let currentNoteId = null;
        let isSidebarEditing = false;
        let isNoteEditing = false;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTree(treeData, document.getElementById('tree-root'));
            
            // Listeners
            document.getElementById('editor').addEventListener('input', debounce(saveNote, 1000));
            document.getElementById('sidebar-search').addEventListener('input', handleSearch);
            
            // Toolbar
            const editor = document.getElementById('editor');
            editor.addEventListener('mouseup', updateToolbarState);
            editor.addEventListener('keyup', updateToolbarState);
            
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('mousedown', (e) => e.preventDefault());
                btn.addEventListener('click', handleToolbar);
            });
        });

        // --- TREE RENDERER ---
        function renderTree(nodes, container) {
            container.innerHTML = '';
            
            nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = 'tree-node';

                // Node Content
                const content = document.createElement('div');
                content.className = `tree-content ${currentNoteId === node.id ? 'active' : ''}`;
                content.onclick = (e) => {
                    if (e.target.closest('.action-btn')) return;
                    if (node.type === 'folder') {
                        node.isOpen = !node.isOpen;
                        renderTree(treeData, document.getElementById('tree-root'));
                    } else {
                        loadNote(node);
                    }
                };

                // Icons
                let icon = node.type === 'folder' 
                    ? `<div class="tree-toggle ${node.isOpen?'rotated':''}">‚ñ∂</div><div class="tree-icon">üìÇ</div>` 
                    : `<div style="width:14px"></div><div class="tree-icon">üìÑ</div>`;

                // Actions (Edit Mode)
                let actions = `
                    <div class="node-actions">
                        ${node.type==='folder' ? `<button class="action-btn btn-add" onclick="addNode('${node.id}')">+</button>` : ''}
                        <button class="action-btn btn-del" onclick="deleteNode('${node.id}')">x</button>
                    </div>
                `;

                content.innerHTML = `${icon}<div class="tree-label">${node.title}</div>${actions}`;
                el.appendChild(content);

                // Children
                if (node.children) {
                    const childContainer = document.createElement('div');
                    childContainer.className = `tree-children ${node.isOpen?'open':''}`;
                    renderTree(node.children, childContainer);
                    el.appendChild(childContainer);
                }

                container.appendChild(el);
            });
        }

        // --- NOTE LOGIC ---
        async function loadNote(node) {
            currentNoteId = node.id;
            
            // Highlight
            document.querySelectorAll('.tree-content').forEach(el => el.classList.remove('active'));
            renderTree(treeData, document.getElementById('tree-root')); // Re-render to show active state

            if (window.innerWidth <= 900) closeSidebar();

            // Set Breadcrumbs/Title
            document.getElementById('breadcrumbs').innerText = "Curriculum"; // Could be dynamic
            document.getElementById('noteTitle').value = node.title;
            document.getElementById('editor').innerHTML = '<span style="color:#666">Loading...</span>';

            // Firebase Load
            try {
                const doc = await db.collection('notes').doc(node.id).get();
                if (doc.exists) {
                    document.getElementById('editor').innerHTML = doc.data().content;
                } else {
                    document.getElementById('editor').innerHTML = node.content || '';
                }
            } catch (e) {
                document.getElementById('editor').innerHTML = node.content || '';
            }
        }

        async function saveNote() {
            if (!currentNoteId) return;
            const content = document.getElementById('editor').innerHTML;
            
            // Local Update
            const node = findNode(treeData, currentNoteId);
            if(node) node.content = content;

            // Firebase Save
            await db.collection('notes').doc(currentNoteId).set({
                content: content,
                lastUpdated: new Date()
            }, { merge: true });
        }

        // --- TREE HELPERS ---
        function findNode(nodes, id) {
            for (let node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNode(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function addNode(parentId) {
            const parent = findNode(treeData, parentId);
            if(!parent) return;
            const title = prompt("Name:");
            if(!title) return;
            const type = confirm("Create Folder? (Cancel for File)") ? 'folder' : 'file';
            
            parent.children.push({
                id: Date.now().toString(),
                title, type, 
                children: type==='folder' ? [] : undefined,
                content: '', isOpen: true
            });
            parent.isOpen = true;
            renderTree(treeData, document.getElementById('tree-root'));
        }

        function deleteNode(id) {
            if(!confirm("Delete?")) return;
            function remove(nodes) {
                const idx = nodes.findIndex(n => n.id === id);
                if (idx > -1) { nodes.splice(idx, 1); return true; }
                for(let n of nodes) { if(n.children && remove(n.children)) return true; }
            }
            remove(treeData);
            renderTree(treeData, document.getElementById('tree-root'));
            if(currentNoteId === id) document.getElementById('editor').innerHTML = '';
        }

        // --- SEARCH ---
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '';
            
            if(query.length < 2) { resBox.style.display = 'none'; return; }

            let matches = [];
            function traverse(nodes, path) {
                nodes.forEach(n => {
                    const myPath = path ? `${path} > ${n.title}` : n.title;
                    if(n.title.toLowerCase().includes(query) || (n.content && n.content.toLowerCase().includes(query))) {
                        matches.push({ node: n, path: myPath });
                    }
                    if(n.children) traverse(n.children, myPath);
                });
            }
            traverse(treeData, "");
            
            if(matches.length > 0) {
                resBox.style.display = 'block';
                matches.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'search-item';
                    d.innerHTML = `<div class="search-path">${m.path}</div><div>${m.node.title}</div>`;
                    d.onclick = () => {
                        if(m.node.type === 'file') loadNote(m.node);
                        else alert("Folder found: Expand tree to view.");
                        resBox.style.display = 'none';
                    };
                    resBox.appendChild(d);
                });
            } else {
                resBox.style.display = 'block';
                resBox.innerHTML = '<div style="padding:10px; color:#666">No results</div>';
            }
        }

        // --- TOGGLES ---
        function toggleSidebarEdit() {
            isSidebarEditing = !isSidebarEditing;
            const btn = document.getElementById('btnEditSidebar');
            const sidebar = document.getElementById('sidebar');
            btn.innerText = isSidebarEditing ? 'Done' : 'Edit Sidebar';
            btn.classList.toggle('active', isSidebarEditing);
            
            if(isSidebarEditing) sidebar.classList.add('sidebar-editing');
            else sidebar.classList.remove('sidebar-editing');
        }

        function toggleNoteEdit() {
            isNoteEditing = !isNoteEditing;
            const btn = document.getElementById('btnEditNote');
            const editor = document.getElementById('editor');
            const toolbar = document.getElementById('toolbar');

            editor.contentEditable = isNoteEditing;
            btn.innerText = isNoteEditing ? 'Edit On' : 'Read Only';
            btn.classList.toggle('active', isNoteEditing);
            
            if(isNoteEditing) toolbar.classList.add('visible');
            else toolbar.classList.remove('visible');
        }

        // --- UTILS ---
        function handleToolbar(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            if(btn.id === 'btn-link') {
                const url = prompt("URL:"); if(url) document.execCommand('createLink', false, url);
            } else if(btn.id === 'btn-img') {
                const url = prompt("Img URL:"); if(url) document.execCommand('insertHTML', false, `<img src="${url}">`);
            } else {
                document.execCommand(btn.dataset.cmd, false, btn.dataset.val);
            }
            updateToolbarState();
        }
        function updateToolbarState() {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                const cmd = btn.dataset.cmd;
                if(cmd && document.queryCommandState(cmd)) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }
        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }
        function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('backdrop').classList.add('open'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('backdrop').classList.remove('open'); }
    </script>
</body>
</html>
