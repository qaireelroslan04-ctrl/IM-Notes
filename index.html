<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IM Notes Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <style>
        :root {
            /* Colors */
            --bg-body: #000000;
            --bg-sidebar: #09090b;
            --bg-card: #09090b;
            --bg-input: #27272a;
            --bg-hover: #27272a;
            --border-color: #27272a;
            --text-main: #e2e8f0;
            --text-muted: #a1a1aa;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --danger: #ef4444;
            --header-bg: rgba(9, 9, 11, 0.85);
            
            --sidebar-width: 280px;
            --header-height: 52px;
            --transition-smooth: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f3f4f6;
            --bg-hover: #f3f4f6;
            --border-color: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --accent-color: #4f46e5;
            --header-bg: rgba(255, 255, 255, 0.85);
        }

        /* --- ACTIVE TOOLBAR BUTTONS --- */
        .fmt-btn.active {
            background-color: rgba(99, 102, 241, 0.2); /* Light Purple */
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        /* --- DRAG AND DROP VISUALS --- */
        .tree-item[draggable="true"] {
            cursor: grab;
        }
        .tree-item.dragging {
            opacity: 0.5;
            background: var(--bg-input);
            border: 1px dashed var(--accent-color);
        }
        .tree-item.drag-over {
            border-top: 2px solid var(--accent-color); /* Shows where it will drop */
            padding-top: 4px;
        }

        /* --- MOBILE DRAG GHOST --- */
    .drag-ghost {
        position: fixed;
        pointer-events: none; /* Let clicks pass through to detect what is underneath */
        background: var(--bg-sidebar);
        border: 1px solid var(--accent-color);
        padding: 8px 12px;
        border-radius: 6px;
        opacity: 0.9;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 1000;
        font-size: 0.85rem;
        color: var(--text-main);
        display: none; /* Hidden by default */
    }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body); color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh; display: flex; overflow: hidden;
            transition: background-color 0.3s;
            user-select: none; /* Default no-select for UI */
        }

        /* --- SIDEBAR --- */
        aside {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .sidebar-header {
            height: var(--header-height); padding: 0 12px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); background: var(--bg-sidebar);
        }

        .app-branding { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background-color: var(--text-muted); transition: var(--transition-smooth); }
        .status-dot.connected { background-color: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.4); }
        .status-dot.disconnected { background-color: var(--danger); }

        .sidebar-actions { display: flex; gap: 4px; }
        .sidebar-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted);
            width: 28px; height: 28px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1rem;
            transition: 0.2s;
        }
        .sidebar-btn:hover { background: var(--bg-hover); color: var(--text-main); }

        .sidebar-search { padding: 8px 12px; border-bottom: 1px solid var(--border-color); }
        .search-input {
            width: 100%; background-color: var(--bg-input); border: 1px solid transparent;
            padding: 6px 10px; border-radius: 6px; color: var(--text-main); font-size: 0.8rem;
            transition: var(--transition-smooth); user-select: text; /* Allow typing */
        }
        .search-input:focus { border-color: var(--accent-color); background: var(--bg-card); }

        .file-tree { flex: 1; overflow-y: auto; padding: 4px 0; padding-bottom: 80px; }
        
        .tree-item {
            display: flex; align-items: center; padding: 2px 10px; 
            cursor: pointer; position: relative; margin: 0;
            transition: background-color 0.1s; color: var(--text-muted);
            border-left: 2px solid transparent; min-height: 26px; 
        }
        .tree-item:hover { background-color: var(--bg-hover); color: var(--text-main); }
        .tree-item.active { background-color: var(--bg-input); color: var(--accent-color); font-weight: 600; border-left-color: var(--accent-color); }
        .tree-item.selected { background-color: rgba(99, 102, 241, 0.15); }
        
        .tree-label { margin-left: 6px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; }
        .type-folder { font-weight: 600; color: var(--text-main); }
        .arrow { width: 12px; height: 12px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem; transition: transform 0.2s; color: var(--text-muted); opacity: 0.7; }
        .arrow.open { transform: rotate(90deg); }

        .select-checkbox {
            width: 14px; height: 14px; border-radius: 3px; border: 1px solid var(--text-muted);
            margin-right: 8px; display: none; align-items: center; justify-content: center; transition: 0.2s;
        }
        .selection-mode .select-checkbox { display: flex; }
        .tree-item.selected .select-checkbox { background: var(--accent-color); border-color: var(--accent-color); }
        .tree-item.selected .select-checkbox::after { content: '‚úì'; font-size: 10px; color: white; font-weight: 800; line-height: 1; }

        /* CONTEXT MENU */
        .context-menu {
            position: fixed; background: var(--bg-sidebar); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 4px; z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none; min-width: 160px;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }
        .context-item {
            padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
            display: flex; align-items: center; gap: 8px; color: var(--text-main); transition: 0.1s;
        }
        .context-item:hover { background: var(--bg-hover); }
        .context-item.danger { color: var(--danger); }

        /* SELECTION BAR */
        .selection-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--header-bg); border-top: 1px solid var(--border-color);
            padding: 8px 12px; display: flex; align-items: center; justify-content: space-between;
            backdrop-filter: blur(12px); z-index: 60;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .selection-bar.visible { transform: translateY(0); }
        .btn-sm { 
            padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-color); 
            background: var(--bg-card); color: var(--text-main); font-size: 0.75rem; cursor: pointer; font-weight: 600;
        }

        /* MOVE MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 300; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--bg-sidebar); border: 1px solid var(--border-color);
            border-radius: 12px; width: 90%; max-width: 400px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 80vh;
        }
        .modal-header { padding: 12px; border-bottom: 1px solid var(--border-color); font-weight: 700; text-align: center; font-size: 0.9rem; }
        .modal-body { padding: 8px; overflow-y: auto; flex: 1; }
        .folder-picker-item { padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .folder-picker-item:hover { background: var(--bg-hover); }

        /* --- MAIN AREA --- */
        main {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--bg-body); position: relative; overflow: hidden;
        }

        header.main-header {
            height: var(--header-height); display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; border-bottom: 1px solid var(--border-color);
            background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 40;
        }

        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-title { font-weight: 700; font-size: 0.95rem; letter-spacing: -0.01em; color: var(--text-main); }
        .toolbar-group { display: flex; align-items: center; gap: 6px; }

        .icon-btn {
            background: none; border: 1px solid transparent; color: var(--text-muted);
            width: 28px; height: 28px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: var(--transition-smooth);
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .icon-btn.active { color: var(--accent-color); background: rgba(99, 102, 241, 0.1); }
        .icon-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 100%; margin-top: 4px;
            background-color: var(--bg-sidebar); min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 100;
            border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;
            animation: fadeIn 0.1s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-content button {
            color: var(--text-main); padding: 10px 14px; text-decoration: none;
            display: block; width: 100%; text-align: left; background: none; border: none; cursor: pointer;
            font-size: 0.8rem; transition: 0.2s;
        }
        .dropdown-content button:hover { background-color: var(--bg-hover); }
        .dropdown.show .dropdown-content { display: block; }

        /* EDITOR TOOLBAR */
        .editor-toolbar {
            display: none; align-items: center; gap: 4px; padding: 6px 16px;
            background: var(--header-bg); border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap; backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 30;
        }
        .editor-toolbar.visible { display: flex; }

        .fmt-btn {
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.8rem;
        }
        .fmt-btn:hover { background: var(--bg-hover); color: var(--text-main); }

        /* --- EDITOR STYLES (Fixed) --- */
        .editor-scroll { flex: 1; overflow-y: auto; padding: 30px; scroll-behavior: smooth; cursor: text; }
        .editor-container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; min-height: 100%; }
        
        .breadcrumbs { font-size: 0.7rem; color: var(--accent-color); margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; background: rgba(99, 102, 241, 0.1); display: inline-block; padding: 2px 6px; border-radius: 4px; user-select: none; }
        
        .note-title-input {
            width: 100%; background: transparent; border: none; color: var(--text-main);
            font-size: 2rem; font-weight: 800; font-family: 'Inter', sans-serif; margin-bottom: 16px; line-height: 1.2; 
            user-select: text; cursor: text;
        }
        
        .note-content { 
            font-size: 1rem; line-height: 1.6; color: var(--text-main); min-height: 60vh; 
            user-select: text; cursor: text; -webkit-user-select: text;
        }
        .note-content:empty:before { content: 'Start writing...'; color: var(--text-muted); opacity: 0.5; }
        
        /* SEARCH STYLES */
        .search-results-container { padding: 0; display: flex; flex-direction: column; }
        .search-result-item { padding: 8px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .search-result-item:hover { background-color: var(--bg-hover); }
        .result-path { font-size: 0.65rem; color: var(--accent-color); margin-bottom: 2px; opacity: 0.8; font-family: 'JetBrains Mono', monospace; }
        .result-title { font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
        .result-snippet { font-size: 0.75rem; color: var(--text-muted); line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .result-snippet mark, .result-title mark { background-color: rgba(99, 102, 241, 0.3); color: #fff; padding: 0 2px; border-radius: 2px; }

        /* Mobile */
        .mobile-hamburger { display: none; background: none; border: none; color: var(--text-main); font-size: 1.2rem; cursor: pointer; padding: 0; margin-right: 8px; }
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 45; }

        @media (max-width: 768px) {
            aside { position: fixed; height: 100%; transform: translateX(-100%); width: 85%; box-shadow: 10px 0 30px rgba(0,0,0,0.3); }
            aside.open { transform: translateX(0); }
            .backdrop.open { display: block; }
            .mobile-hamburger { display: block; }
            header.main-header { padding: 0 12px; }
            .editor-scroll { padding: 20px 16px; }
            .note-title-input { font-size: 1.6rem; }
        }
    </style>
</head>
<body>

<div id="backdrop" class="backdrop" onclick="toggleSidebar(false)"></div>

<div id="context-menu" class="context-menu"></div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">Move Selection To...</div>
        <div class="modal-body" id="move-list"></div>
        <div style="padding:12px; text-align:right; border-top:1px solid var(--border-color);">
            <button class="btn-sm" onclick="document.getElementById('move-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<div id="template-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">Choose a Template</div>
        <div class="modal-body" id="template-list">
            </div>
        <div style="padding:12px; text-align:right; border-top:1px solid var(--border-color);">
            <button class="btn-sm" onclick="document.getElementById('template-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<aside id="app-sidebar">
    <div class="sidebar-header">
        <div class="app-branding">
            <div id="connection-indicator" class="status-dot" title="Connecting..."></div>
            <span>IM Notes Pro</span>
        </div>
        <div class="sidebar-actions">
            <button class="sidebar-btn" onclick="addRootFolder()" title="New Main Topic">Ôºã</button>
            <button class="sidebar-btn" onclick="toggleAllFolders(false)" title="Collapse All">‚àí</button>
        </div>
    </div>
    
    <div class="sidebar-search">
        <input type="text" class="search-input" placeholder="Search..." id="search-input">
    </div>

    <div id="file-tree" class="file-tree">
        <div style="padding:20px; text-align:center; color:var(--text-muted); font-size:0.8rem;">Connecting...</div>
    </div>

    <div id="selection-bar" class="selection-bar">
        <span style="font-size:0.8rem; font-weight:600; color:var(--text-main);"><span id="sel-count">0</span> Selected</span>
        <div style="display:flex; gap:6px;">
            <button class="btn-sm" onclick="renameSelected()">Rename</button>
            <button class="btn-sm" onclick="openMoveModal()">Move</button>
            <button class="btn-sm" onclick="deleteSelected()" style="color:var(--danger); border-color:var(--danger);">Del</button>
            <button class="btn-sm" onclick="exitSelectionMode()">Done</button>
        </div>
    </div>
</aside>

<main id="app-main">
    
    <header class="main-header">
        <div class="header-left">
            <button class="mobile-hamburger" onclick="toggleSidebar(true)">‚ò∞</button>
            <span class="header-title">Workspace</span>
        </div>

        <div class="toolbar-group">
            <button id="mode-toggle" class="icon-btn" onclick="toggleEditMode()" title="Toggle Read/Edit">
                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">
                <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
            </button>

            <div class="dropdown">
                <button class="icon-btn" onclick="toggleDropdown()">
                    <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                </button>
                <div id="settings-dropdown" class="dropdown-content">
                    <button onclick="initializeWithPDFData()" style="color: var(--accent-color); font-weight:600;">Initialize / Reset DB</button>
                    <button onclick="exportData()">Export JSON</button>
                    <button onclick="importData()">Import JSON</button>
                    <button onclick="sanitizeCurrentNote()">‚ú® Clean NotebookLM Text</button>
                </div>
            </div>
        </div>
    </header>

    <div id="editor-toolbar" class="editor-toolbar">
        <button class="fmt-btn" onclick="fmt('bold')" title="Bold"><b>B</b></button>
        <button class="fmt-btn" onclick="fmt('italic')" title="Italic"><i>I</i></button>
        <button class="fmt-btn" onclick="fmt('underline')" title="Underline"><u>U</u></button>
        <button class="fmt-btn" onclick="fmt('strikeThrough')" title="Strikethrough"><s>S</s></button>
        
        <div style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></div>
        
        <button class="fmt-btn" onclick="fmt('formatBlock', 'H2')" title="Heading 2">H2</button>
        <button class="fmt-btn" onclick="fmt('formatBlock', 'H3')" title="Heading 3">H3</button>
        <button class="fmt-btn" onclick="fmt('formatBlock', 'blockquote')" title="Quote">‚ùû</button>
        <button class="fmt-btn" onclick="fmt('formatBlock', 'PRE')" title="Code Block">&lt;/&gt;</button>

        <div style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></div>
        
        <button class="fmt-btn" onclick="fmt('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
        <button class="fmt-btn" onclick="fmt('insertOrderedList')" title="Numbered List">1. List</button>
        <button class="fmt-btn" onclick="insertChecklist()" title="Checklist">‚òë List</button>
        
        <div style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></div>

        <button class="fmt-btn" onclick="createLink()" title="Link">üîó</button>
        <input type="file" id="img-upload" hidden accept="image/*">
        <button class="fmt-btn" onclick="triggerImageUpload()" title="Insert Image">Image</button>
        <button class="fmt-btn" onclick="insertVideo()" title="Insert YouTube">Youtube Video</button>
        <button class="fmt-btn" onclick="insertTable()" title="Insert Table">Table</button>
        <button class="fmt-btn" onclick="fmt('insertHorizontalRule')" title="Divider">‚Äî‚Äî</button>
        <button class="fmt-btn" onclick="openTemplatePicker()" title="Insert Template">üìã Template</button>
    </div>

    <div class="editor-scroll" onclick="focusEditor()">
        <div class="editor-container">
            <div id="breadcrumbs" class="breadcrumbs">Vault</div>
            <input type="text" id="note-title" class="note-title-input" placeholder="Select a note..." readonly>
            <div id="editor" class="note-content" contenteditable="false"></div>
        </div>
    </div>

</main>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
        authDomain: "im-helper-d3a4a.firebaseapp.com",
        projectId: "im-helper-d3a4a",
        storageBucket: "im-helper-d3a4a.firebasestorage.app",
        messagingSenderId: "772636018512",
        appId: "1:772636018512:web:80d03d582a3384746f4e55",
        measurementId: "G-JTPQPT45CY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. STATE ---
    let vaultData = [];
    let currentNoteId = null;
    let isEditMode = false;
    let saveTimeout;
    
    // Selection & UI State
    let isSelectionMode = false;
    let selectedNodes = new Set(); 
    let longPressTimer;

    // --- 3. INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        loadStructureFromDB();
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        document.getElementById('search-input').addEventListener('input', handleSearch);
        
        // Editor Input Logic
        document.getElementById('editor').addEventListener('input', () => {
             const content = document.getElementById('editor').innerHTML;
             if(currentNoteId) {
                 const node = findNode(vaultData, currentNoteId);
                 if(node) node.content = content;
                 clearTimeout(saveTimeout);
                 saveTimeout = setTimeout(() => saveNoteContent(currentNoteId), 1000);
             }
        });

        // Close Context Menu on click
        window.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        // Dropdown Close
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                document.getElementById("settings-dropdown").parentElement.classList.remove('show');
            }
            if(!event.target.closest('.context-menu')) {
                document.getElementById('context-menu').style.display = 'none';
            }
        }

        document.getElementById('editor').addEventListener('paste', handlePaste);
        document.getElementById('img-upload').addEventListener('change', handleImageFile);
    });

    // --- 4. TREE RENDERER (Ultra Compact) ---
    // --- FIXED TREE RENDERER (Step 1) ---
    function renderTree(nodes, container, depth = 0) {
        container.innerHTML = '';
        if(depth === 0) container.className = 'file-tree'; 
    
        if(nodes.length === 0 && depth === 0) {
             container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">Empty Vault.<br>Click Ôºã to create.</div>';
             return;
        }
    
        nodes.forEach((node, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'tree-item';
            
            // CRUCIAL FIX: This allows the Drop function to find the ID
            itemDiv.dataset.id = node.id; 
            
            // Desktop Drag attribute
            itemDiv.setAttribute('draggable', 'true');
            
            if (currentNoteId === node.id) itemDiv.classList.add('active');
            if (selectedNodes.has(node.id)) itemDiv.classList.add('selected');
            
            if (isSelectionMode) document.getElementById('app-sidebar').classList.add('selection-mode');
            
            const arrow = node.type === 'folder' 
                ? `<span class="arrow ${node.isOpen ? 'open' : ''}">‚ñ∂</span>` 
                : `<span style="width:12px; display:inline-block"></span>`;
    
            const typeClass = node.type === 'folder' ? 'type-folder' : 'type-file';
    
            itemDiv.innerHTML = `
                <div style="padding-left:${depth * 14}px; display:flex; align-items:center; width:100%; pointer-events:none;">
                    <div class="select-checkbox" style="pointer-events:auto;"></div>
                    ${arrow} 
                    <span class="tree-label ${typeClass}">${node.title}</span>
                </div>
            `;
    
            // --- DESKTOP EVENTS ---
            itemDiv.addEventListener('dragstart', (e) => handleDragStart(e, node));
            itemDiv.addEventListener('dragover', (e) => handleDragOver(e));
            itemDiv.addEventListener('dragleave', (e) => { e.target.classList.remove('drag-over'); });
            itemDiv.addEventListener('drop', (e) => handleDrop(e, node));
            itemDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault(); e.stopPropagation();
                showContextMenu(e.clientX, e.clientY, node, nodes, index);
            });
    
            // --- MOBILE EVENTS (The Fix) ---
            itemDiv.addEventListener('touchstart', (e) => handleTouchStart(e, node));
            itemDiv.addEventListener('touchmove', (e) => handleTouchMove(e));
            itemDiv.addEventListener('touchend', (e) => handleTouchEnd(e, node));
    
            // --- CLICK ---
            itemDiv.onclick = (e) => {
                // If we just finished a gesture, ignore the click
                if(wasGestureActive) { wasGestureActive = false; return; }
                
                if (isSelectionMode) {
                    toggleNodeSelection(node.id);
                } else {
                    if (node.type === 'folder') {
                        node.isOpen = !node.isOpen;
                        saveStructureToDB();
                        renderTree(vaultData, document.getElementById('file-tree'));
                    } else {
                        openNote(node);
                        if(window.innerWidth <= 768) toggleSidebar(false);
                    }
                }
            };
    
            container.appendChild(itemDiv);
    
            if (node.type === 'folder' && node.isOpen && node.children) {
                const childrenContainer = document.createElement('div');
                renderTree(node.children, childrenContainer, depth + 1);
                container.appendChild(childrenContainer);
            }
        });
    }

    // --- ROBUST MOBILE GESTURE SYSTEM (Step 2) ---
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let activeNode = null;
    
    let isDragging = false;     // Are we currently dragging a ghost?
    let holdTimer = null;       // Timer for Context Menu
    let ghostEl = null;
    let wasGestureActive = false; // Flag to prevent 'click' after a drag/menu
    
    function handleTouchStart(e, node) {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchStartTime = Date.now();
        activeNode = node;
        
        isDragging = false;
        wasGestureActive = false;
    
        // cleanup any leftovers
        clearTimeout(holdTimer);
        if(ghostEl) removeGhost();
    
        // Start Timer: If held still for 500ms -> Context Menu
        holdTimer = setTimeout(() => {
            // If we haven't started dragging yet...
            if (!isDragging) {
                wasGestureActive = true; // Block the click
                showContextMenu(touchStartX, touchStartY, node, getParentArray(vaultData, node.id), 0);
                // Vibrate to indicate success
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }, 500);
    }
    
    function handleTouchMove(e) {
        if (!activeNode) return;
        
        const touch = e.touches[0];
        const moveX = Math.abs(touch.clientX - touchStartX);
        const moveY = Math.abs(touch.clientY - touchStartY);
    
        // 1. If moved > 10px, it's NOT a static hold. Cancel Context Menu.
        if (moveX > 10 || moveY > 10) {
            clearTimeout(holdTimer);
        }
    
        // 2. LOGIC: Drag vs Scroll
        // If we are ALREADY dragging, move the ghost
        if (isDragging) {
            e.preventDefault(); // Stop Browser Scroll
            moveGhost(touch.clientX, touch.clientY);
            highlightDropTarget(touch.clientX, touch.clientY);
            return;
        }
    
        // 3. START DRAGGING CHECK
        // If moved > 10px...
        if (moveX > 10 || moveY > 10) {
            const timeElapsed = Date.now() - touchStartTime;
            
            // If held for > 200ms before moving -> It's a Drag
            if (timeElapsed > 200) {
                isDragging = true;
                wasGestureActive = true;
                e.preventDefault(); // Stop scroll
                createGhost(touch.clientX, touch.clientY, activeNode.title);
                if(navigator.vibrate) navigator.vibrate(30);
            } 
            // If moved immediately (< 200ms) -> It's a Scroll. Do nothing.
        }
    }
    
    function handleTouchEnd(e, node) {
        // Always clear timer
        clearTimeout(holdTimer);
        
        if (isDragging) {
            e.preventDefault();
            
            // 1. Find Drop Target based on finger position
            const touch = e.changedTouches[0];
            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
            const itemWrapper = targetEl ? targetEl.closest('.tree-item') : null;
            
            // 2. Execute Logic
            if (itemWrapper && itemWrapper.dataset.id && activeNode) {
                const dropId = itemWrapper.dataset.id;
                
                // Prevent dropping on self
                if(dropId !== activeNode.id) {
                    
                    // CRITICAL FIX: Set the global variable used by handleDrop
                    draggedNodeId = activeNode.id; 
                    
                    const dropTargetNode = findNode(vaultData, dropId);
                    
                    if(dropTargetNode) {
                        // Pass a safe mock event object
                        handleDrop({ preventDefault: ()=>{} }, dropTargetNode);
                    }
                }
            }
        }
        
        // Visual Cleanup
        removeGhost();
        document.querySelectorAll('.tree-item.drag-over').forEach(el => el.classList.remove('drag-over'));
        
        isDragging = false;
        activeNode = null;
        
        // Keep 'wasGestureActive' true briefly so the 'onclick' (which fires after touchend) knows to ignore this tap
        setTimeout(() => { wasGestureActive = false; }, 50);
    }
    
    // --- VISUAL HELPERS ---
    function createGhost(x, y, title) {
        removeGhost(); // Ensure only one exists
        ghostEl = document.createElement('div');
        ghostEl.className = 'drag-ghost';
        ghostEl.innerText = title;
        ghostEl.style.display = 'block';
        ghostEl.style.left = (x + 10) + 'px';
        ghostEl.style.top = (y + 10) + 'px';
        document.body.appendChild(ghostEl);
    }
    
    function moveGhost(x, y) {
        if(ghostEl) {
            ghostEl.style.left = (x + 10) + 'px';
            ghostEl.style.top = (y + 10) + 'px';
        }
    }
    
    function removeGhost() {
        if(ghostEl && ghostEl.parentNode) {
            ghostEl.parentNode.removeChild(ghostEl);
        }
        ghostEl = null;
    }
    
    function highlightDropTarget(x, y) {
        const targetEl = document.elementFromPoint(x, y);
        const item = targetEl ? targetEl.closest('.tree-item') : null;
        
        document.querySelectorAll('.tree-item.drag-over').forEach(el => el.classList.remove('drag-over'));
        if(item) item.classList.add('drag-over');
    }
    
    // --- UNIFIED EDITOR KEY HANDLER (Hotkeys + Smart Format) ---
    document.getElementById('editor').addEventListener('keydown', function(e) {
        
        // 1. HOTKEYS (Ctrl/Cmd + Key)
        if (e.ctrlKey || e.metaKey) {
            const key = e.key.toLowerCase();
            
            switch(key) {
                case 'b': // Bold
                    e.preventDefault();
                    document.execCommand('bold');
                    break;
                case 'i': // Italic
                    e.preventDefault();
                    document.execCommand('italic');
                    break;
                case 'u': // Underline
                    e.preventDefault();
                    document.execCommand('underline');
                    break;
                case 's': // Save (Prevent browser "Save Page" dialog)
                    e.preventDefault();
                    if(currentNoteId) saveNoteContent(currentNoteId);
                    // Optional: visual feedback
                    const btn = document.getElementById('connection-indicator');
                    btn.style.backgroundColor = '#6366f1'; // Flash blue
                    setTimeout(()=> btn.style.backgroundColor = '', 200);
                    break;
            }
            return; // Stop processing if it was a hotkey
        }
    
        // 2. TAB KEY (Indent/Outdent)
        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand(e.shiftKey ? 'outdent' : 'indent');
            return;
        }
    
        // 3. SMART FORMATTING (Spacebar triggers)
        if (e.key === ' ') {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
    
            const range = selection.getRangeAt(0);
            const node = selection.anchorNode;
    
            // Ensure we are inside a text node
            if (node.nodeType === 3) {
                const text = node.textContent;
                const offset = selection.anchorOffset;
    
                // Pattern: "- " -> Bullet List
                if (text.trim().startsWith('-') && offset <= 2) {
                    e.preventDefault(); 
                    // Clean the text (remove the "- ")
                    node.textContent = text.substring(2); 
                    document.execCommand('insertUnorderedList');
                }
                
                // Pattern: "1. " -> Numbered List
                else if (text.trim().startsWith('1.') && offset <= 3) {
                    e.preventDefault();
                    node.textContent = text.substring(3);
                    document.execCommand('insertOrderedList');
                }
                
                // Pattern: "[] " -> Checklist
                else if (text.trim().startsWith('[]') && offset <= 3) {
                    e.preventDefault();
                    node.textContent = text.substring(3);
                    const checkboxHtml = '<input type="checkbox" style="margin-right:8px; vertical-align:middle;">&nbsp;';
                    document.execCommand('insertHTML', false, checkboxHtml);
                }
            }
        }
    });

    // --- ADVANCED NOTEBOOKLM CLEANER (v2.0) ---
    function cleanNotebookLMText(html) {
        let clean = html;
    
        // 1. Replace Standard Math Symbols (Order matters!)
        clean = clean
            .replace(/\\ge/g, '‚â•')          // \ge -> ‚â•
            .replace(/\\le/g, '‚â§')          // \le -> ‚â§
            .replace(/\\approx/g, '‚âà')      // \approx -> ‚âà
            .replace(/\\pm/g, '¬±')          // \pm -> ¬±
            .replace(/\\ne/g, '‚â†')          // \ne -> ‚â†
            .replace(/\\times/g, '√ó')       // \times -> √ó
            .replace(/\\rightarrow/g, '‚Üí')  // \rightarrow -> ‚Üí
            .replace(/\\leftarrow/g, '‚Üê')   // \leftarrow -> ‚Üê
            .replace(/\^\\circ/g, '¬∞')      // ^\circ -> ¬∞
            .replace(/\^\{\\circ\}/g, '¬∞'); // ^{ \circ } -> ¬∞
    
        // 2. Remove LaTeX "text" wrappers
        // Converts \text{C} -> C, \text{words} -> words
        clean = clean.replace(/\\text\{([^}]+)\}/g, '$1');
    
        // 3. Convert Subscripts (e.g., V_1 -> V‚ÇÅ, V_{12} -> V‚ÇÅ‚ÇÇ)
        // Matches a letter followed by underscore and number (with or without brackets)
        clean = clean.replace(/([a-zA-Z])_\{?(\d+)\}?/g, (match, letter, num) => {
            const subs = "‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ";
            const subNum = num.split('').map(d => subs[parseInt(d)] || d).join('');
            return letter + subNum;
        });
    
        // 4. Convert Superscripts (e.g., ^2 -> ¬≤)
        // Matches carat followed by number
        clean = clean.replace(/\^\{?(\d+)\}?/g, (match, num) => {
            const supers = "‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ";
            const superNum = num.split('').map(d => supers[parseInt(d)] || d).join('');
            return superNum;
        });
    
        // 5. Final Cleanup: Remove all remaining Dollar Signs ($)
        // This handles cases like "$V‚ÇÅ$-$V‚ÇÜ$" becoming "V‚ÇÅ-V‚ÇÜ"
        clean = clean.replace(/\$/g, '');
    
        return clean;
    }
    
    // Function to clean the CURRENT note (Retroactive fix)
    function sanitizeCurrentNote() {
        const editor = document.getElementById('editor');
        const original = editor.innerHTML;
        const cleaned = cleanNotebookLMText(original);
        
        if(original !== cleaned) {
            editor.innerHTML = cleaned;
            if(currentNoteId) saveNoteContent(currentNoteId);
            alert("Note cleaned of NotebookLM artifacts!");
        } else {
            alert("No artifacts found to clean.");
        }
    }

    // --- 5. OPERATIONS ---
    function addRootFolder() {
        const name = prompt("Name of new Main Topic:");
        if(name) {
            vaultData.push({ id: Date.now().toString(), title: name, type: 'folder', isOpen: true, children: [] });
            saveStructureToDB();
            renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    function showContextMenu(x, y, node, parentArray, index) {
        if(isSelectionMode) return;
        const menu = document.getElementById('context-menu');
        menu.style.display = 'block';
        
        const menuWidth = 160; const menuHeight = 280;
        const left = (x + menuWidth > window.innerWidth) ? x - menuWidth : x;
        const top = (y + menuHeight > window.innerHeight) ? y - menuHeight : y;
        
        menu.style.left = left + 'px'; menu.style.top = top + 'px';

        // ADDED: "Move To..." option below Rename
        let html = `
            <div class="context-item" onclick="enterSelectionMode('${node.id}')">‚ú® Select</div>
            <div class="context-item" onclick="renameNode('${node.id}')">‚úé Rename</div>
            <div class="context-item" onclick="initiateSingleMove('${node.id}')">‚ûî Move To...</div>
            ${node.type === 'folder' ? `
                <div class="context-item" onclick="addFile('${node.id}')">Ôºã New File</div>
                <div class="context-item" onclick="addFolder('${node.id}')">üóÇ New Folder</div>
            ` : ''}
            <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
            ${index > 0 ? `<div class="context-item" onclick="reorderNode('${node.id}', -1)">‚Üë Move Up</div>` : ''}
            ${index < parentArray.length - 1 ? `<div class="context-item" onclick="reorderNode('${node.id}', 1)">‚Üì Move Down</div>` : ''}
            <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
            <div class="context-item danger" onclick="deleteNode('${node.id}')">üóë Delete</div>
        `;
        menu.innerHTML = html;
    }

    function reorderNode(id, direction) {
        const arr = getParentArray(vaultData, id);
        if(!arr) return;
        const index = arr.findIndex(n => n.id === id);
        if(index === -1) return;
        
        const newIndex = index + direction;
        if(newIndex >= 0 && newIndex < arr.length) {
            [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
            saveStructureToDB();
            renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    // --- 6. SELECTION & MASS MOVE ---
    function enterSelectionMode(initialId) {
        isSelectionMode = true; selectedNodes.clear();
        if(initialId) selectedNodes.add(initialId);
        updateSelectionUI();
    }
    function toggleNodeSelection(id) {
        if(selectedNodes.has(id)) selectedNodes.delete(id); else selectedNodes.add(id);
        updateSelectionUI();
    }
    function updateSelectionUI() {
        renderTree(vaultData, document.getElementById('file-tree'));
        const bar = document.getElementById('selection-bar');
        bar.classList.add('visible');
        document.getElementById('sel-count').innerText = selectedNodes.size;
    }
    function exitSelectionMode() {
        isSelectionMode = false; selectedNodes.clear();
        document.getElementById('selection-bar').classList.remove('visible');
        document.getElementById('app-sidebar').classList.remove('selection-mode');
        renderTree(vaultData, document.getElementById('file-tree'));
    }
    function renameSelected() {
        if(selectedNodes.size !== 1) { alert("Select exactly one item to rename."); return; }
        const id = Array.from(selectedNodes)[0];
        renameNode(id); exitSelectionMode();
    }
    function openMoveModal() {
        if(selectedNodes.size === 0) return;
        const modal = document.getElementById('move-modal');
        const list = document.getElementById('move-list');
        list.innerHTML = `<div class="folder-picker-item" onclick="moveSelectedTo('root')">üè† Root (Main)</div>`;
        
        function listFolders(nodes, depth=0) {
            nodes.forEach(n => {
                if(n.type === 'folder' && !selectedNodes.has(n.id)) { 
                    const div = document.createElement('div');
                    div.className = 'folder-picker-item';
                    div.innerHTML = `<span style="margin-left:${depth*15}px">üìÅ ${n.title}</span>`;
                    div.onclick = () => moveSelectedTo(n.id);
                    list.appendChild(div);
                    if(n.children) listFolders(n.children, depth+1);
                }
            });
        }
        listFolders(vaultData); modal.style.display = 'flex';
    }
    function moveSelectedTo(targetFolderId) {
        const itemsToMove = [];
        function extract(nodes) {
            for(let i = nodes.length - 1; i >= 0; i--) {
                const node = nodes[i];
                if(selectedNodes.has(node.id)) { itemsToMove.push(node); nodes.splice(i, 1); }
                else if(node.children) extract(node.children);
            }
        }
        extract(vaultData);
        if(targetFolderId === 'root') vaultData.push(...itemsToMove);
        else {
            const target = findNode(vaultData, targetFolderId);
            if(target) { if(!target.children) target.children = []; target.children.push(...itemsToMove); target.isOpen = true; }
            else vaultData.push(...itemsToMove);
        }
        saveStructureToDB(); document.getElementById('move-modal').style.display = 'none'; exitSelectionMode();
    }
    function deleteSelected() {
        if(!confirm(`Delete ${selectedNodes.size} items?`)) return;
        function remove(nodes) {
            for(let i = nodes.length - 1; i >= 0; i--) {
                const node = nodes[i];
                if(selectedNodes.has(node.id)) nodes.splice(i, 1);
                else if(node.children) remove(node.children);
            }
        }
        remove(vaultData); saveStructureToDB(); exitSelectionMode();
        if(selectedNodes.has(currentNoteId)) { document.getElementById('editor').innerHTML = ''; document.getElementById('note-title').value = ''; }
    }

    // --- 7. UTILS ---
    function findNode(nodes, id) {
        for(let node of nodes) {
            if(node.id === id) return node;
            if(node.children) { let found = findNode(node.children, id); if(found) return found; }
        }
        return null;
    }
    function getParentArray(nodes, id) {
        for(let node of nodes) {
            if(node.id === id) return nodes;
            if(node.children) {
                if(node.children.some(c => c.id === id)) return node.children;
                let found = getParentArray(node.children, id); if(found) return found;
            }
        }
        return null;
    }
    function renameNode(id) {
        const node = findNode(vaultData, id);
        const newName = prompt("Rename to:", node.title);
        if(newName) {
            node.title = newName; saveStructureToDB(); renderTree(vaultData, document.getElementById('file-tree'));
            if(currentNoteId === id) document.getElementById('note-title').value = newName;
        }
    }
    function deleteNode(id) {
        if(!confirm("Delete this item?")) return;
        function remove(nodes) {
            const idx = nodes.findIndex(n => n.id === id);
            if(idx > -1) { nodes.splice(idx, 1); return true; }
            for(let n of nodes) { if(n.children && remove(n.children)) return true; }
        }
        remove(vaultData); saveStructureToDB(); renderTree(vaultData, document.getElementById('file-tree'));
        if(currentNoteId === id) { document.getElementById('editor').innerHTML = ''; document.getElementById('note-title').value = ''; }
    }
    function addFile(parentId) {
        const parent = findNode(vaultData, parentId);
        const name = prompt("Name of new note:");
        if(name) {
            if(!parent.children) parent.children = [];
            // CHANGED: push -> unshift (Adds to top)
            parent.children.unshift({ id: Date.now().toString(), title: name, type: 'file', content: '' });
            parent.isOpen = true; saveStructureToDB(); renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    function addFolder(parentId) {
        const parent = findNode(vaultData, parentId);
        const name = prompt("Name of new folder:");
        if(name) {
            if(!parent.children) parent.children = [];
            // CHANGED: push -> unshift (Adds to top)
            parent.children.unshift({ id: Date.now().toString(), title: name, type: 'folder', isOpen: true, children: [] });
            parent.isOpen = true; saveStructureToDB(); renderTree(vaultData, document.getElementById('file-tree'));
        }
    }

    // --- TEMPLATE SYSTEM LOGIC ---

    async function openTemplatePicker() {
        // 1. Find the "Templates" folder
        const templateFolder = vaultData.find(n => n.type === 'folder' && n.title.toLowerCase() === 'templates');
    
        if (!templateFolder) {
            if(confirm('No "Templates" folder found. Create one now?')) {
                // Create the folder automatically
                vaultData.unshift({ 
                    id: Date.now().toString(), 
                    title: 'Templates', 
                    type: 'folder', 
                    isOpen: true, 
                    children: [] 
                });
                saveStructureToDB();
                renderTree(vaultData, document.getElementById('file-tree'));
                alert('Folder created! Add some notes inside "Templates" to use them.');
            }
            return;
        }
    
        if (!templateFolder.children || templateFolder.children.length === 0) {
            alert('The "Templates" folder is empty. Create a note inside it first.');
            return;
        }
    
        // 2. Render list of templates
        const listContainer = document.getElementById('template-list');
        listContainer.innerHTML = '';
    
        templateFolder.children.forEach(file => {
            if(file.type === 'file') {
                const div = document.createElement('div');
                div.className = 'folder-picker-item'; // Reuse existing style
                div.innerHTML = `üìÑ ${file.title}`;
                div.onclick = () => applyTemplate(file.id);
                listContainer.appendChild(div);
            }
        });
    
        // 3. Show Modal
        document.getElementById('template-modal').style.display = 'flex';
    }
    
    async function applyTemplate(templateId) {
        // Show loading state
        const modalBody = document.getElementById('template-list');
        modalBody.innerHTML = '<div style="padding:10px; text-align:center;">Loading template...</div>';
    
        try {
            // 1. Fetch the content of the template note
            // We use the same 'notes' collection you already have
            const doc = await db.collection('notes').doc(templateId).get();
            
            if (doc.exists) {
                const tmplContent = doc.data().content;
                
                // 2. Insert into Editor
                // We append it to the current cursor position
                if (tmplContent) {
                    fmt('insertHTML', tmplContent);
                }
            }
            
            // 3. Close Modal
            document.getElementById('template-modal').style.display = 'none';
            
        } catch (error) {
            console.error("Error loading template:", error);
            alert("Failed to load template content.");
            document.getElementById('template-modal').style.display = 'none';
        }
    }

    // --- 8. Single Move ---

    function initiateSingleMove(id) {
        // Clear previous selection and select only this node
        selectedNodes.clear();
        selectedNodes.add(id);
        // Reuse your existing modal logic
        openMoveModal(); 
        // Hide context menu
        document.getElementById('context-menu').style.display = 'none';
    }

    // --- STANDARD APP FUNCTIONS ---

    // --- DRAG AND DROP LOGIC ---

    let draggedNodeId = null;
    
    function handleDragStart(e, node) {
        draggedNodeId = node.id;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        // Optional: Set a drag image if you want custom styling
    }
    
    function handleDragOver(e) {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
        
        // Add visual cue
        const target = e.target.closest('.tree-item');
        if(target) target.classList.add('drag-over');
    }
    
    function handleDrop(e, targetNode) {
        e.preventDefault();
        
        // FIX: Check if e.target exists before using it (Prevents mobile crash)
        if (e.target) {
            const targetEl = e.target.closest('.tree-item');
            if(targetEl) targetEl.classList.remove('drag-over');
        }
        
        // Safety checks
        if(!draggedNodeId || draggedNodeId === targetNode.id) return;
    
        // 1. Remove node from old location
        let movedNode = null;
        function remove(nodes) {
            const idx = nodes.findIndex(n => n.id === draggedNodeId);
            if(idx > -1) {
                movedNode = nodes[idx];
                nodes.splice(idx, 1);
                return true;
            }
            for(let n of nodes) {
                if(n.children && remove(n.children)) return true;
            }
        }
        remove(vaultData);
    
        // 2. Insert node at new location (Before the target node)
        if(movedNode) {
            const parentArr = getParentArray(vaultData, targetNode.id);
            if(parentArr) {
                const targetIdx = parentArr.findIndex(n => n.id === targetNode.id);
                parentArr.splice(targetIdx, 0, movedNode);
                
                // Save and Rerender
                saveStructureToDB();
                renderTree(vaultData, document.getElementById('file-tree'));
            }
        }
        
        // Reset global ID
        draggedNodeId = null;
    }
    
    async function loadStructureFromDB() {
        const dot = document.getElementById('connection-indicator');
        try {
            const doc = await db.collection('config').doc('treeStructure').get();
            dot.classList.add('connected');
            if (doc.exists) { vaultData = doc.data().tree; renderTree(vaultData, document.getElementById('file-tree')); }
            else { vaultData = []; renderTree([], document.getElementById('file-tree')); }
        } catch (error) { console.error(error); dot.classList.add('disconnected'); document.getElementById('file-tree').innerHTML = '<div style="padding:20px; text-align:center; color:#ef4444">Connection Failed</div>'; }
    }
    async function saveStructureToDB() { try { await db.collection('config').doc('treeStructure').set({ tree: vaultData }); } catch(e) { console.error("Save failed", e); } }
    async function saveNoteContent(id) {
        const content = document.getElementById('editor').innerHTML;
        const title = document.getElementById('note-title').value;
        const node = findNode(vaultData, id);
        if(node) node.content = content; 
        try { await db.collection('notes').doc(id).set({ content: content, title: title, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); saveStructureToDB(); } catch(e) { console.error(e); }
    }
    async function openNote(node) {
        currentNoteId = node.id; renderTree(vaultData, document.getElementById('file-tree')); 
        document.getElementById('breadcrumbs').innerText = getBreadcrumbs(vaultData, node.id) || "Vault";
        document.getElementById('note-title').value = node.title;
        document.getElementById('editor').innerHTML = '<span style="color:var(--text-muted)">Loading...</span>';
        if(window.innerWidth <= 768) toggleSidebar(false);
        try {
            const doc = await db.collection('notes').doc(node.id).get();
            if(doc.exists) { const data = doc.data(); document.getElementById('editor').innerHTML = data.content; node.content = data.content; }
            else { document.getElementById('editor').innerHTML = node.content || ''; }
        } catch(e) { document.getElementById('editor').innerHTML = node.content || ''; }
    }
    function getBreadcrumbs(nodes, id, path = '') {
        for(let node of nodes) {
            if(node.id === id) return path ? `${path} / ${node.title}` : node.title;
            if(node.children) { let found = getBreadcrumbs(node.children, id, path ? `${path} / ${node.title}` : node.title); if(found) return found; }
        }
        return null;
    }
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('mode-toggle');
        const editor = document.getElementById('editor');
        const toolbar = document.getElementById('editor-toolbar');
        const titleInput = document.getElementById('note-title');
        if(isEditMode) { btn.classList.add('active'); editor.contentEditable = true; titleInput.removeAttribute('readonly'); toolbar.classList.add('visible'); editor.focus(); }
        else { btn.classList.remove('active'); editor.contentEditable = false; titleInput.setAttribute('readonly', true); toolbar.classList.remove('visible'); if(currentNoteId) saveNoteContent(currentNoteId); }
    }
    function fmt(cmd, val) { document.execCommand(cmd, false, val); document.getElementById('editor').focus(); }
    function triggerImageUpload() { document.getElementById('img-upload').click(); }
    function handleImageFile(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) { fmt('insertHTML', `<img src="${event.target.result}" style="max-width:100%; border-radius:8px; margin:10px 0;">`); };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    }
    // --- FIXED PASTE HANDLER (Images + Text Cleaner) ---
    function handlePaste(e) {
        if (!isEditMode) return;
    
        // 1. Check for Images FIRST
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        let hasImage = false;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                e.preventDefault();
                hasImage = true;
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Insert Image
                    document.execCommand('insertHTML', false, `<img src="${event.target.result}" style="max-width:100%; border-radius:8px; margin:10px 0;">`);
                };
                reader.readAsDataURL(blob);
                return; // Stop processing, we found our image
            }
        }
    
        // 2. If NO Image, handle as Text/HTML (with Cleaning)
        if (!hasImage) {
            e.preventDefault();
            
            // Get Data
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            const html = (e.clipboardData || window.clipboardData).getData('text/html');
    
            // Prefer HTML, fallback to text
            let contentToPaste = html || text;
    
            // Run the NotebookLM Cleaner
            if (contentToPaste) {
                contentToPaste = cleanNotebookLMText(contentToPaste);
                document.execCommand('insertHTML', false, contentToPaste);
            }
        }
    }
    function insertVideo() { 
        const url = prompt("Paste YouTube URL:"); 
        if(url) {
            const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
            const videoId = match ? match[1] : null;
            if(videoId) fmt('insertHTML', `<div style="position:relative; padding-bottom:56.25%; height:0; margin:1rem 0; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.2);"><iframe src="https://www.youtube.com/embed/${videoId}" style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" allowfullscreen></iframe></div><p><br></p>`);
            else alert("Invalid YouTube URL");
        }
    }
    function stripHtml(html) { let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
    function handleSearch(e) {
        const query = e.target.value.toLowerCase();
        const tree = document.getElementById('file-tree');
        if(query.length < 2) { renderTree(vaultData, tree); return; }
        let results = [];
        function traverse(nodes, path) {
            nodes.forEach(n => {
                const currentPath = path ? `${path} > ${n.title}` : n.title;
                if(n.type === 'file') {
                    const plainContent = n.content ? stripHtml(n.content) : "";
                    if(n.title.toLowerCase().includes(query) || plainContent.toLowerCase().includes(query)) {
                        let snippet = "";
                        const idx = plainContent.toLowerCase().indexOf(query);
                        if(idx !== -1) {
                            const start = Math.max(0, idx - 30);
                            const end = Math.min(plainContent.length, idx + query.length + 50);
                            snippet = (start>0?"...":"") + plainContent.substring(start, end) + (end<plainContent.length?"...":"");
                        } else snippet = plainContent.substring(0, 80) + "...";
                        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        results.push({ node: n, path: currentPath, titleHtml: n.title.replace(regex, "<mark>$1</mark>"), snippetHtml: snippet.replace(regex, "<mark>$1</mark>") });
                    }
                }
                if(n.children) traverse(n.children, currentPath);
            });
        }
        traverse(vaultData, "");
        tree.innerHTML = ''; tree.className = 'search-results-container';
        if(results.length === 0) tree.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No matches</div>';
        else results.forEach(res => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.innerHTML = `<div class="result-path">${res.path}</div><div class="result-title">${res.titleHtml}</div><div class="result-snippet">${res.snippetHtml}</div>`;
            div.onclick = () => openNote(res.node);
            tree.appendChild(div);
        });
    }
    function insertChecklist() {
        // Inserts a clickable checkbox followed by a space
        const checkboxHtml = '<input type="checkbox" style="margin-right:8px; vertical-align:middle;">&nbsp;';
        fmt('insertHTML', checkboxHtml);
    }

    function createLink() {
        const url = prompt("Enter Link URL:");
        if (url) fmt('createLink', url);
    }

    // --- TOOLBAR STATE MANAGER ---
    function updateToolbarState() {
        if (!isEditMode) return;
        
        // List of commands to check
        const cmds = [
            { cmd: 'bold', btn: "fmt('bold')" },
            { cmd: 'italic', btn: "fmt('italic')" },
            { cmd: 'underline', btn: "fmt('underline')" },
            { cmd: 'strikeThrough', btn: "fmt('strikeThrough')" },
            { cmd: 'insertUnorderedList', btn: "fmt('insertUnorderedList')" },
            { cmd: 'insertOrderedList', btn: "fmt('insertOrderedList')" }
        ];
    
        cmds.forEach(item => {
            // Query the browser: "Is the text at cursor Bold?"
            const isActive = document.queryCommandState(item.cmd);
            
            // Find the button by its onclick attribute (simple way to match without adding IDs)
            // Or you can add IDs to buttons. This selector is a quick hack that works with your current code.
            const btn = document.querySelector(`button[onclick="${item.btn}"]`);
            
            if (btn) {
                if (isActive) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        });
    }
    
    // Attach listeners to trigger the check
    const editor = document.getElementById('editor');
    editor.addEventListener('keyup', updateToolbarState);
    editor.addEventListener('mouseup', updateToolbarState);
    editor.addEventListener('click', updateToolbarState);

    function insertTable() {
        const rows = 2; // Default 2x2
        const cols = 2;
        let html = '<table style="width:100%; border-collapse: collapse; margin: 10px 0; border: 1px solid var(--border-color);">';
        for (let i = 0; i < rows; i++) {
            html += '<tr>';
            for (let j = 0; j < cols; j++) {
                html += '<td style="border: 1px solid var(--border-color); padding: 8px;">Cell</td>';
            }
            html += '</tr>';
        }
        html += '</table><br>'; // Add break so user can type after
        fmt('insertHTML', html);
    }
    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }
    function toggleSidebar(force) {
        const sb = document.getElementById('app-sidebar');
        const bd = document.getElementById('backdrop');
        const open = force !== undefined ? force : !sb.classList.contains('open');
        sb.classList.toggle('open', open); bd.classList.toggle('open', open);
    }
    function toggleAllFolders(state) {
        function toggle(nodes) { nodes.forEach(n => { if(n.type==='folder') { n.isOpen = state; if(n.children) toggle(n.children); } }); }
        toggle(vaultData); renderTree(vaultData, document.getElementById('file-tree'));
    }
    function focusEditor() { if(isEditMode) document.getElementById('editor').focus(); }
    function toggleDropdown() { document.getElementById("settings-dropdown").parentElement.classList.toggle('show'); }
    function initializeWithPDFData() {
        if(!confirm("Reset?")) return;
        vaultData = [{ id: '1', title: 'Main Folder', type: 'folder', isOpen: true, children: [] }];
        saveStructureToDB(); renderTree(vaultData, document.getElementById('file-tree'));
    }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vaultData));
        const a = document.createElement('a'); a.href = dataStr; a.download = "im_vault_backup.json"; a.click();
    }
    function importData() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.readAsText(file, 'UTF-8');
        reader.onload = readerEvent => {
            try {
                // 1. Parse the new data
                const importedData = JSON.parse(readerEvent.target.result);
                
                // 2. CHECK: Is the imported data an array?
                if (Array.isArray(importedData)) {
                    // 3. MERGE: Push new items into existing vaultData
                    // Optional: Wrap import in a folder so it's tidy
                    const importFolder = {
                        id: Date.now().toString(),
                        title: "Imported " + new Date().toLocaleDateString(),
                        type: 'folder',
                        isOpen: true,
                        children: importedData
                    };
                    
                    // Add to the top of your list
                    vaultData.unshift(importFolder); 
                    
                    // 4. Save and Render
                    saveStructureToDB(); 
                    renderTree(vaultData, document.getElementById('file-tree'));
                    alert("Collection Added Successfully");
                } else {
                    alert("Invalid Data Format: Root must be an array");
                }
            } catch(err) { 
                console.error(err);
                alert("Invalid JSON"); 
            }
        }
    }
    input.click();
}
</script>

</body>
</html>
